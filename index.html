<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Облік кореспонденції</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.5;
            padding: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .menu-item {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border: none;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .menu-item .icon {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .menu-item .title {
            font-size: 14px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-container {
            display: none;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-container.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .table-container {
            display: none;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-height: 70vh;
            overflow-y: auto;
        }

        .table-container.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .doc-number-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 700;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #6c757d);
            color: var(--tg-theme-text-color, #ffffff);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            margin: 2px;
        }

        .search-container {
            display: none;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .search-container.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .search-tabs {
            display: flex;
            margin-bottom: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            overflow: hidden;
        }

        .search-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .search-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .search-results {
            margin-top: 20px;
        }

        .document-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .document-table th,
        .document-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .document-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .document-table td {
            font-size: 13px;
            max-width: 200px;
            word-wrap: break-word;
        }

        .document-table .actions {
            white-space: nowrap;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .document-number {
            font-weight: 700;
            color: #667eea;
        }

        .document-type {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .type-incoming {
            background: #d1ecf1;
            color: #0c5460;
        }

        .type-outgoing {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload-label:hover {
            border-color: #5a67d8;
            background: rgba(102, 126, 234, 0.1);
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .help-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .help-section {
            margin-bottom: 24px;
        }

        .help-section h4 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .help-section p, .help-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .help-section ul {
            padding-left: 20px;
        }

        .file-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .file-link:hover {
            text-decoration: underline;
        }

        .no-files {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📋 Облік кореспонденції</h1>
        <p>Система обліку вхідної та вихідної кореспонденції</p>
    </div>

    <div class="stats-container">
        <div class="stat-card" onclick="showIncomingTable()">
            <div class="stat-number" id="incomingCount">0</div>
            <div class="stat-label">Вхідні документи</div>
        </div>
        <div class="stat-card" onclick="showOutgoingTable()">
            <div class="stat-number" id="outgoingCount">0</div>
            <div class="stat-label">Вихідні документи</div>
        </div>
    </div>

    <div class="menu-grid">
        <button class="menu-item" onclick="showIncomingForm()">
            <span class="icon">📥</span>
            <span class="title">Нова вхідна</span>
        </button>
        <button class="menu-item" onclick="showOutgoingForm()">
            <span class="icon">📤</span>
            <span class="title">Нова вихідна</span>
        </button>
        <button class="menu-item" onclick="showSearch()">
            <span class="icon">🔍</span>
            <span class="title">Пошук</span>
        </button>
        <button class="menu-item" onclick="showHelp()">
            <span class="icon">ℹ️</span>
            <span class="title">Довідка</span>
        </button>
    </div>

    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>

    <!-- Таблиця вхідних документів -->
    <div class="table-container" id="incomingTable">
        <h3>📥 Вхідна кореспонденція</h3>
        <div class="export-section">
            <button class="btn btn-secondary" onclick="exportIncoming()">📊 Експорт в Excel</button>
        </div>
        <div id="incomingTableContent"></div>
        <button class="btn btn-secondary" onclick="hideAllForms()">❌ Закрити</button>
    </div>

    <!-- Таблиця вихідних документів -->
    <div class="table-container" id="outgoingTable">
        <h3>📤 Вихідна кореспонденція</h3>
        <div class="export-section">
            <button class="btn btn-secondary" onclick="exportOutgoing()">📊 Експорт в Excel</button>
        </div>
        <div id="outgoingTableContent"></div>
        <button class="btn btn-secondary" onclick="hideAllForms()">❌ Закрити</button>
    </div>

    <!-- Форма вхідної кореспонденції -->
    <div class="form-container" id="incomingForm">
        <h3>📥 Реєстрація вхідної кореспонденції</h3>
        <div class="doc-number-display" id="incomingDocNumber"></div>
        <form id="incomingFormData">
            <div class="form-group">
                <label for="inRegistrar">Хто реєструє документ</label>
                <input type="text" id="inRegistrar" name="registrar" required 
                       placeholder="П.І.Б. особи, що реєструє документ">
            </div>
            <div class="form-group">
                <label for="inFromWhom">Від кого</label>
                <input type="text" id="inFromWhom" name="fromWhom" required 
                       placeholder="Назва організації або особи">
            </div>
            <div class="form-group">
                <label for="inSubject">Об'єкт документа</label>
                <input type="text" id="inSubject" name="subject" required 
                       placeholder="Тема або предмет документа">
            </div>
            <div class="form-group">
                <label for="inContent">Зміст документа</label>
                <textarea id="inContent" name="content" required 
                          placeholder="Короткий опис змісту документа"></textarea>
            </div>
            <div class="form-group">
                <label for="inDate">Дата отримання</label>
                <input type="date" id="inDate" name="receivedDate" required>
            </div>
            <div class="form-group">
                <label for="inNotes">Примітки (необов'язково)</label>
                <textarea id="inNotes" name="notes" 
                          placeholder="Додаткові примітки до документа"></textarea>
            </div>
            <div class="form-group">
                <label>Прикріпити файл (необов'язково)</label>
                <div class="file-upload">
                    <input type="file" id="inFile" name="file" accept=".pdf,.doc,.docx,.xlsx,.xls,.jpg,.png">
                    <label for="inFile" class="file-upload-label">
                        📎 Вибрати файл
                    </label>
                </div>
            </div>
            <button type="submit" class="btn">✅ Зареєструвати документ</button>
            <button type="button" class="btn btn-secondary" onclick="hideAllForms()">❌ Скасувати</button>
        </form>
    </div>

    <!-- Форма вихідної кореспонденції -->
    <div class="form-container" id="outgoingForm">
        <h3>📤 Реєстрація вихідної кореспонденції</h3>
        <div class="doc-number-display" id="outgoingDocNumber"></div>
        <form id="outgoingFormData">
            <div class="form-group">
                <label for="outRegistrar">Хто реєструє документ</label>
                <input type="text" id="outRegistrar" name="registrar" required 
                       placeholder="П.І.Б. особи, що реєструє документ">
            </div>
            <div class="form-group">
                <label for="outToWhom">Кому</label>
                <input type="text" id="outToWhom" name="toWhom" required 
                       placeholder="Назва організації або особи">
            </div>
            <div class="form-group">
                <label for="outSubject">Об'єкт документа</label>
                <input type="text" id="outSubject" name="subject" required 
                       placeholder="Тема або предмет документа">
            </div>
            <div class="form-group">
                <label for="outContent">Зміст документа</label>
                <textarea id="outContent" name="content" required 
                          placeholder="Короткий опис змісту документа"></textarea>
            </div>
            <div class="form-group">
                <label for="outDate">Дата відправки</label>
                <input type="date" id="outDate" name="sentDate" required>
            </div>
            <div class="form-group">
                <label for="outNotes">Примітки (необов'язково)</label>
                <textarea id="outNotes" name="notes" 
                          placeholder="Додаткові примітки до документа"></textarea>
            </div>
            <div class="form-group">
                <label>Прикріпити файл (необов'язково)</label>
                <div class="file-upload">
                    <input type="file" id="outFile" name="file" accept=".pdf,.doc,.docx,.xlsx,.xls,.jpg,.png">
                    <label for="outFile" class="file-upload-label">
                        📎 Вибрати файл
                    </label>
                </div>
            </div>
            <button type="submit" class="btn">✅ Зареєструвати документ</button>
            <button type="button" class="btn btn-secondary" onclick="hideAllForms()">❌ Скасувати</button>
        </form>
    </div>

    <!-- Пошук -->
    <div class="search-container" id="searchContainer">
        <h3>🔍 Пошук документів</h3>
        
        <div class="search-tabs">
            <button class="search-tab active" onclick="setSearchType('all')">Всі</button>
            <button class="search-tab" onclick="setSearchType('incoming')">📥 Вхідні</button>
            <button class="search-tab" onclick="setSearchType('outgoing')">📤 Вихідні</button>
        </div>

        <div class="form-group">
            <label for="searchQuery">Пошуковий запит</label>
            <input type="text" id="searchQuery" placeholder="Введіть ключові слова для пошуку">
        </div>
        <button class="btn" onclick="performSearch()">🔍 Знайти</button>
        <button class="btn btn-secondary" onclick="hideAllForms()">❌ Закрити</button>
        
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- Довідка -->
    <div class="form-container" id="helpContainer">
        <h3>ℹ️ Довідка по використанню</h3>
        
        <div class="help-content">
            <div class="help-section">
                <h4>📋 Основні функції</h4>
                <ul>
                    <li><strong>📥 Нова вхідна</strong> - реєстрація отриманих документів</li>
                    <li><strong>📤 Нова вихідна</strong> - реєстрація відправлених документів</li>
                    <li><strong>🔍 Пошук</strong> - знаходження документів за ключовими словами</li>
                    <li><strong>Статистика</strong> - натисніть на цифри вгорі для перегляду всіх документів</li>
                </ul>
            </div>

            <div class="help-section">
                <h4>📝 Як реєструвати документи</h4>
                <p>1. <strong>Номер генерується автоматично</strong> - одразу після відкриття форми ви побачите номер документа</p>
                <p>2. <strong>Заповніть всі обов'язкові поля:</strong></p>
                <ul>
                    <li>Хто реєструє документ (ваше П.І.Б.)</li>
                    <li>Від кого/Кому</li>
                    <li>Об'єкт документа</li>
                    <li>Зміст документа</li>
                    <li>Дата отримання/відправки</li>
                </ul>
                <p>3. <strong>За бажанням:</strong> додайте примітки та прикріпіть файл</p>
                <p>4. <strong>Натисніть "Зареєструвати документ"</strong></p>
            </div>

            <div class="help-section">
                <h4>🔍 Як шукати документи</h4>
                <p>Пошук працює за всіма полями:</p>
                <ul>
                    <li>Номер документа</li>
                    <li>Від кого/Кому</li>
                    <li>Тема документа</li>
                    <li>Зміст</li>
                    <li>Примітки</li>
                    <li>П.І.Б. реєстратора</li>
                </ul>
                <p>Можна шукати окремо по вхідній або вихідній кореспонденції, використовуючи вкладки.</p>
            </div>

            <div class="help-section">
                <h4>📁 Де знаходяться прикріплені файли</h4>
                <p><strong>Важливо:</strong> Файли зберігаються локально в вашому браузері.</p>
                <p><strong>Для перегляду файлів:</strong></p>
                <ul>
                    <li>Натисніть на цифру вхідних або вихідних документів вгорі</li>
                    <li>Відкриється таблиця з усіма документами</li>
                    <li>У колонці "Файли" натисніть "📎 Переглянути" або "⬇️ Завантажити"</li>
                </ul>
                <p><strong>Експорт даних:</strong> В кожній таблиці є кнопка "📊 Експорт в Excel" для створення Excel-файлу з посиланнями на файли</p>
            </div>

            <div class="help-section">
                <h4>💾 Збереження даних</h4>
                <p>Всі дані зберігаються локально в вашому браузері. Це означає:</p>
                <ul>
                    <li>✅ Швидкий доступ до ваших даних</li>
                    <li>✅ Працює без інтернету (після першого завантаження)</li>
                    <li>⚠️ Дані доступні тільки в цьому браузері на цьому пристрої</li>
                    <li>⚠️ Очищення кешу браузера видалить дані</li>
                </ul>
                <p><strong>Рекомендація:</strong> Регулярно робіть експорт для резервного копіювання</p>
            </div>

            <div class="help-section">
                <h4>🆘 Підтримка</h4>
                <p>Якщо у вас виникли питання або проблеми:</p>
                <ul>
                    <li>Спробуйте оновити сторінку</li>
                    <li>Перевірте, чи заповнені всі обов'язкові поля</li>
                    <li>Для файлів: підтримуються PDF, DOC, DOCX, XLS, XLSX, JPG, PNG</li>
                </ul>
            </div>
        </div>

        <button class="btn btn-secondary" onclick="hideAllForms()">❌ Закрити довідку</button>
    </div>

    <script>
        // Ініціалізація Telegram WebApp
        const tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // Змінна для типу пошуку
        let currentSearchType = 'all';

        // База даних в localStorage
        class DocumentDatabase {
            constructor() {
                this.incomingKey = 'correspondence_incoming';
                this.outgoingKey = 'correspondence_outgoing';
                this.counterKey = 'correspondence_counters';
                this.filesKey = 'correspondence_files';
            }

            getIncoming() {
                return JSON.parse(localStorage.getItem(this.incomingKey) || '[]');
            }

            getOutgoing() {
                return JSON.parse(localStorage.getItem(this.outgoingKey) || '[]');
            }

            getCounters() {
                return JSON.parse(localStorage.getItem(this.counterKey) || '{"incoming": 0, "outgoing": 0}');
            }

            getFiles() {
                return JSON.parse(localStorage.getItem(this.filesKey) || '{}');
            }

            saveIncoming(documents) {
                localStorage.setItem(this.incomingKey, JSON.stringify(documents));
            }

            saveOutgoing(documents) {
                localStorage.setItem(this.outgoingKey, JSON.stringify(documents));
            }

            saveCounters(counters) {
                localStorage.setItem(this.counterKey, JSON.stringify(counters));
            }

            saveFiles(files) {
                localStorage.setItem(this.filesKey, JSON.stringify(files));
            }

            generateDocNumber(type) {
                const counters = this.getCounters();
                const date = new Date();
                const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                
                counters[type]++;
                this.saveCounters(counters);
                
                const prefix = type === 'incoming' ? 'IN' : 'OUT';
                const number = String(counters[type]).padStart(3, '0');
                
                return `${prefix}-${dateStr}-${number}`;
            }

            addDocument(type, data, docNumber = null) {
                const documents = type === 'incoming' ? this.getIncoming() : this.getOutgoing();
                
                const document = {
                    id: Date.now(),
                    docNumber: docNumber || this.generateDocNumber(type),
                    ...data,
                    createdAt: new Date().toISOString()
                };

                documents.push(document);
                
                if (type === 'incoming') {
                    this.saveIncoming(documents);
                } else {
                    this.saveOutgoing(documents);
                }

                return document;
            }

            saveFile(docNumber, file) {
                const files = this.getFiles();
                const reader = new FileReader();
                
                return new Promise((resolve) => {
                    reader.onload = function(e) {
                        files[docNumber] = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };
                        localStorage.setItem('correspondence_files', JSON.stringify(files));
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            }

            getFile(docNumber) {
                const files = this.getFiles();
                return files[docNumber] || null;
            }

            search(query, type = 'all') {
                let documents = [];
                
                if (type === 'all' || type === 'incoming') {
                    const incoming = this.getIncoming().map(doc => ({ ...doc, type: 'incoming' }));
                    documents = documents.concat(incoming);
                }
                
                if (type === 'all' || type === 'outgoing') {
                    const outgoing = this.getOutgoing().map(doc => ({ ...doc, type: 'outgoing' }));
                    documents = documents.concat(outgoing);
                }

                const lowerQuery = query.toLowerCase();
                return documents.filter(doc => {
                    return (
                        (doc.registrar && doc.registrar.toLowerCase().includes(lowerQuery)) ||
                        (doc.fromWhom && doc.fromWhom.toLowerCase().includes(lowerQuery)) ||
                        (doc.toWhom && doc.toWhom.toLowerCase().includes(lowerQuery)) ||
                        (doc.subject && doc.subject.toLowerCase().includes(lowerQuery)) ||
                        (doc.content && doc.content.toLowerCase().includes(lowerQuery)) ||
                        (doc.notes && doc.notes.toLowerCase().includes(lowerQuery)) ||
                        (doc.docNumber && doc.docNumber.toLowerCase().includes(lowerQuery))
                    );
                });
            }
        }

        const db = new DocumentDatabase();

        // Ініціалізація при завантаженні
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            setDefaultDates();
        });

        function updateStats() {
            const incoming = db.getIncoming();
            const outgoing = db.getOutgoing();
            
            document.getElementById('incomingCount').textContent = incoming.length;
            document.getElementById('outgoingCount').textContent = outgoing.length;
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const inDate = document.getElementById('inDate');
            const outDate = document.getElementById('outDate');
            
            if (inDate) inDate.value = today;
            if (outDate) outDate.value = today;
        }

        function showMessage(message, type = 'success') {
            const successEl = document.getElementById('successMessage');
            const errorEl = document.getElementById('errorMessage');
            
            // Приховуємо всі повідомлення
            successEl.classList.remove('active');
            errorEl.classList.remove('active');
            
            // Показуємо потрібне
            if (type === 'success') {
                successEl.textContent = message;
                successEl.classList.add('active');
            } else {
                errorEl.textContent = message;
                errorEl.classList.add('active');
            }
            
            // Автоматично приховуємо через 5 секунд
            setTimeout(() => {
                successEl.classList.remove('active');
                errorEl.classList.remove('active');
            }, 5000);
            
            // Прокручуємо до початку сторінки
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideAllForms() {
            document.querySelectorAll('.form-container, .search-container, .table-container').forEach(form => {
                form.classList.remove('active');
            });
        }

        function showIncomingForm() {
            hideAllForms();
            const docNumber = db.generateDocNumber('incoming');
            document.getElementById('incomingDocNumber').textContent = `Номер документа: ${docNumber}`;
            document.getElementById('incomingForm').classList.add('active');
            window.scrollTo({ top: document.getElementById('incomingForm').offsetTop - 20, behavior: 'smooth' });
        }

        function showOutgoingForm() {
            hideAllForms();
            const docNumber = db.generateDocNumber('outgoing');
            document.getElementById('outgoingDocNumber').textContent = `Номер документа: ${docNumber}`;
            document.getElementById('outgoingForm').classList.add('active');
            window.scrollTo({ top: document.getElementById('outgoingForm').offsetTop - 20, behavior: 'smooth' });
        }

        function showIncomingTable() {
            hideAllForms();
            renderDocumentTable('incoming');
            document.getElementById('incomingTable').classList.add('active');
            window.scrollTo({ top: document.getElementById('incomingTable').offsetTop - 20, behavior: 'smooth' });
        }

        function showOutgoingTable() {
            hideAllForms();
            renderDocumentTable('outgoing');
            document.getElementById('outgoingTable').classList.add('active');
            window.scrollTo({ top: document.getElementById('outgoingTable').offsetTop - 20, behavior: 'smooth' });
        }

        function showSearch() {
            hideAllForms();
            document.getElementById('searchContainer').classList.add('active');
            window.scrollTo({ top: document.getElementById('searchContainer').offsetTop - 20, behavior: 'smooth' });
        }

        function showHelp() {
            hideAllForms();
            document.getElementById('helpContainer').classList.add('active');
            window.scrollTo({ top: document.getElementById('helpContainer').offsetTop - 20, behavior: 'smooth' });
        }

        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('.search-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        }

        function renderDocumentTable(type) {
            const documents = type === 'incoming' ? db.getIncoming() : db.getOutgoing();
            const containerId = type === 'incoming' ? 'incomingTableContent' : 'outgoingTableContent';
            const container = document.getElementById(containerId);
            
            if (documents.length === 0) {
                container.innerHTML = '<div class="no-files">📋 Документи відсутні</div>';
                return;
            }

            const orgLabel = type === 'incoming' ? 'Від кого' : 'Кому';
            const dateLabel = type === 'incoming' ? 'Дата отримання' : 'Дата відправки';
            
            let tableHTML = `
                <table class="document-table">
                    <thead>
                        <tr>
                            <th>Номер</th>
                            <th>Реєстратор</th>
                            <th>${orgLabel}</th>
                            <th>Тема</th>
                            <th>Зміст</th>
                            <th>${dateLabel}</th>
                            <th>Файли</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            documents.forEach(doc => {
                const file = db.getFile(doc.docNumber);
                const fileCell = file ? 
                    `<button class="btn btn-small" onclick="viewFile('${doc.docNumber}')">📎 Переглянути</button>
                     <button class="btn btn-small" onclick="downloadFile('${doc.docNumber}')">⬇️ Завантажити</button>` :
                    '<span class="no-files">Немає</span>';

                tableHTML += `
                    <tr>
                        <td><strong>${doc.docNumber}</strong></td>
                        <td>${doc.registrar || 'Не вказано'}</td>
                        <td>${doc.fromWhom || doc.toWhom || 'Не вказано'}</td>
                        <td>${doc.subject || 'Не вказано'}</td>
                        <td>${(doc.content || 'Не вказано').length > 50 ? 
                            (doc.content || 'Не вказано').substring(0, 50) + '...' : 
                            (doc.content || 'Не вказано')}</td>
                        <td>${doc.receivedDate || doc.sentDate || 'Не вказано'}</td>
                        <td class="actions">${fileCell}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function viewFile(docNumber) {
            const file = db.getFile(docNumber);
            if (!file) {
                showMessage('❌ Файл не знайдено', 'error');
                return;
            }

            // Відкриваємо файл в новому вікні
            const newWindow = window.open();
            if (file.type.includes('image')) {
                newWindow.document.write(`
                    <html>
                        <head><title>Перегляд файлу - ${file.name}</title></head>
                        <body style="margin:0;padding:20px;text-align:center;">
                            <h3>${file.name}</h3>
                            <img src="${file.data}" style="max-width:100%;height:auto;" />
                        </body>
                    </html>
                `);
            } else {
                newWindow.location.href = file.data;
            }
        }

        function downloadFile(docNumber) {
            const file = db.getFile(docNumber);
            if (!file) {
                showMessage('❌ Файл не знайдено', 'error');
                return;
            }

            const a = document.createElement('a');
            a.href = file.data;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage(`✅ Файл "${file.name}" завантажено`);
        }

        // Експорт в Excel
        function exportIncoming() {
            exportToExcel(db.getIncoming(), 'incoming', 'Вхідна кореспонденція');
        }

        function exportOutgoing() {
            exportToExcel(db.getOutgoing(), 'outgoing', 'Вихідна кореспонденція');
        }

        function exportToExcel(documents, type, title) {
            if (documents.length === 0) {
                showMessage('❌ Немає документів для експорту', 'error');
                return;
            }

            const orgLabel = type === 'incoming' ? 'Від кого' : 'Кому';
            const dateLabel = type === 'incoming' ? 'Дата отримання' : 'Дата відправки';
            
            let csvContent = '\uFEFF'; // BOM для правильного відображення українських символів
            
            // Заголовки
            csvContent += `"Номер документа","Реєстратор","${orgLabel}","Тема","Зміст","${dateLabel}","Примітки","Файл","Посилання на завантаження"\n`;
            
            // Дані
            documents.forEach(doc => {
                const file = db.getFile(doc.docNumber);
                const fileName = file ? file.name : 'Немає';
                const fileLink = file ? `data:${file.type};base64,${file.data.split(',')[1]}` : 'Немає';
                
                const row = [
                    doc.docNumber || '',
                    doc.registrar || '',
                    doc.fromWhom || doc.toWhom || '',
                    doc.subject || '',
                    doc.content || '',
                    doc.receivedDate || doc.sentDate || '',
                    doc.notes || '',
                    fileName,
                    fileLink
                ].map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',');
                
                csvContent += row + '\n';
            });

            // Створення та завантаження файлу
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${title}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage(`✅ Експорт "${title}" завершено успішно!`);
        }

        // Обробка форм
        document.getElementById('incomingFormData').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const formData = new FormData(this);
                const docNumber = document.getElementById('incomingDocNumber').textContent.split(': ')[1];
                
                const data = {
                    registrar: formData.get('registrar'),
                    fromWhom: formData.get('fromWhom'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    receivedDate: formData.get('receivedDate'),
                    notes: formData.get('notes') || ''
                };

                // Обробка файлу
                const file = formData.get('file');
                if (file && file.size > 0) {
                    await db.saveFile(docNumber, file);
                }

                // Зменшуємо лічильник, оскільки номер вже згенерований
                const counters = db.getCounters();
                counters.incoming--;
                db.saveCounters(counters);

                const document = db.addDocument('incoming', data, docNumber);
                
                showMessage(`✅ Вхідний документ успішно зареєстровано! Номер: ${document.docNumber}`);
                
                this.reset();
                setDefaultDates();
                updateStats();
                hideAllForms();

                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'document_registered',
                        type: 'incoming',
                        docNumber: document.docNumber
                    }));
                }
            } catch (error) {
                showMessage('❌ Помилка при збереженні документа', 'error');
                console.error(error);
            }
        });

        document.getElementById('outgoingFormData').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const formData = new FormData(this);
                const docNumber = document.getElementById('outgoingDocNumber').textContent.split(': ')[1];
                
                const data = {
                    registrar: formData.get('registrar'),
                    toWhom: formData.get('toWhom'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    sentDate: formData.get('sentDate'),
                    notes: formData.get('notes') || ''
                };

                // Обробка файлу
                const file = formData.get('file');
                if (file && file.size > 0) {
                    await db.saveFile(docNumber, file);
                }

                // Зменшуємо лічильник, оскільки номер вже згенерований
                const counters = db.getCounters();
                counters.outgoing--;
                db.saveCounters(counters);

                const document = db.addDocument('outgoing', data, docNumber);
                
                showMessage(`✅ Вихідний документ успішно зареєстровано! Номер: ${document.docNumber}`);
                
                this.reset();
                setDefaultDates();
                updateStats();
                hideAllForms();

                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'document_registered',
                        type: 'outgoing',
                        docNumber: document.docNumber
                    }));
                }
            } catch (error) {
                showMessage('❌ Помилка при збереженні документа', 'error');
                console.error(error);
            }
        });

        function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                showMessage('⚠️ Введіть пошуковий запит', 'error');
                return;
            }

            try {
                const results = db.search(query, currentSearchType);
                
                const resultsContainer = document.getElementById('searchResults');
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <span style="font-size: 48px;">🔍</span>
                            <p>За запитом "${query}" документи не знайдено</p>
                        </div>
                    `;
                } else {
                    const typeLabel = currentSearchType === 'incoming' ? 'вхідних' : 
                                     currentSearchType === 'outgoing' ? 'вихідних' : '';
                    
                    resultsContainer.innerHTML = `
                        <h4>Знайдено ${typeLabel} документів: ${results.length}</h4>
                        ${results.map(doc => {
                            const file = db.getFile(doc.docNumber);
                            return `
                            <div class="document-card">
                                <div class="document-header">
                                    <span class="document-number">${doc.docNumber}</span>
                                    <span class="document-type ${doc.type === 'incoming' ? 'type-incoming' : 'type-outgoing'}">
                                        ${doc.type === 'incoming' ? '📥 Вхідний' : '📤 Вихідний'}
                                    </span>
                                </div>
                                <div class="document-content">
                                    <div class="field">
                                        <span class="label">Реєстратор:</span>
                                        ${doc.registrar || 'Не вказано'}
                                    </div>
                                    <div class="field">
                                        <span class="label">${doc.type === 'incoming' ? 'Від:' : 'Кому:'}</span>
                                        ${doc.fromWhom || doc.toWhom}
                                    </div>
                                    <div class="field">
                                        <span class="label">Тема:</span>
                                        ${doc.subject}
                                    </div>
                                    <div class="field">
                                        <span class="label">Зміст:</span>
                                        ${doc.content.length > 100 ? doc.content.substring(0, 100) + '...' : doc.content}
                                    </div>
                                    <div class="field">
                                        <span class="label">Дата:</span>
                                        ${doc.receivedDate || doc.sentDate}
                                    </div>
                                    ${file ? `
                                        <div class="field">
                                            <span class="label">📎 Файл:</span>
                                            ${file.name}
                                            <br>
                                            <button class="btn btn-small" onclick="viewFile('${doc.docNumber}')">👁️ Переглянути</button>
                                            <button class="btn btn-small" onclick="downloadFile('${doc.docNumber}')">⬇️ Завантажити</button>
                                        </div>
                                    ` : ''}
                                    ${doc.notes ? `
                                        <div class="field">
                                            <span class="label">Примітки:</span>
                                            ${doc.notes}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `}).join('')}
                    `;
                }
            } catch (error) {
                showMessage('❌ Помилка при пошуку', 'error');
                console.error(error);
            }
        }

        // Обробка файлів
        document.getElementById('inFile').addEventListener('change', function(e) {
            const label = document.querySelector('label[for="inFile"]');
            if (e.target.files.length > 0) {
                label.textContent = `📎 ${e.target.files[0].name}`;
            } else {
                label.textContent = '📎 Вибрати файл';
            }
        });

        document.getElementById('outFile').addEventListener('change', function(e) {
            const label = document.querySelector('label[for="outFile"]');
            if (e.target.files.length > 0) {
                label.textContent = `📎 ${e.target.files[0].name}`;
            } else {
                label.textContent = '📎 Вибрати файл';
            }
        });

        // Пошук по Enter
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Telegram WebApp налаштування
        if (tg) {
            // Налаштування кольорової схеми
            if (tg.themeParams) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f8f9fa');
            }

            // Обробка кнопки назад
            tg.onEvent('backButtonClicked', function() {
                hideAllForms();
                tg.BackButton.hide();
            });

            // Показуємо кнопку назад при відкритті форм
            const originalFunctions = {
                showIncomingForm: showIncomingForm,
                showOutgoingForm: showOutgoingForm,
                showSearch: showSearch,
                showHelp: showHelp,
                showIncomingTable: showIncomingTable,
                showOutgoingTable: showOutgoingTable
            };

            showIncomingForm = function() {
                originalFunctions.showIncomingForm();
                tg.BackButton.show();
            };

            showOutgoingForm = function() {
                originalFunctions.showOutgoingForm();
                tg.BackButton.show();
            };

            showSearch = function() {
                originalFunctions.showSearch();
                tg.BackButton.show();
            };

            showHelp = function() {
                originalFunctions.showHelp();
                tg.BackButton.show();
            };

            showIncomingTable = function() {
                originalFunctions.showIncomingTable();
                tg.BackButton.show();
            };

            showOutgoingTable = function() {
                originalFunctions.showOutgoingTable();
                tg.BackButton.show();
            };

            const originalHideAllForms = hideAllForms;
            hideAllForms = function() {
                originalHideAllForms();
                tg.BackButton.hide();
            };
        }

        // Демо-дані для тестування (розкоментуйте для додавання тестових даних)
        /*
        function addDemoData() {
            if (db.getIncoming().length === 0 && db.getOutgoing().length === 0) {
                db.addDocument('incoming', {
                    registrar: 'Іванов І.І.',
                    fromWhom: 'Міністерство освіти і науки України',
                    subject: 'Щодо проведення атестації',
                    content: 'Інформуємо про терміни проведення атестації педагогічних працівників',
                    receivedDate: '2024-09-01',
                    notes: 'Термінове виконання до 15.09.2024'
                });

                db.addDocument('outgoing', {
                    registrar: 'Петренко П.П.',
                    toWhom: 'Департамент освіти та науки',
                    subject: 'Звіт про виконану роботу',
                    content: 'Подаємо звіт про виконану роботу за серпень 2024 року',
                    sentDate: '2024-09-05',
                    notes: 'Відправлено електронною поштою'
                });

                updateStats();
            }
        }
        addDemoData();
        */
    </script>
</body>
</html>
