<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±–ª—ñ–∫ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.5;
            padding: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .menu-item {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border: none;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .menu-item:hover::before {
            left: 100%;
        }

        .menu-item .icon {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .menu-item .title {
            font-size: 14px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-container {
            display: none;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-container.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #6c757d);
            color: var(--tg-theme-text-color, #ffffff);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .search-container {
            display: none;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .search-container.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .search-results {
            margin-top: 20px;
        }

        .document-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .document-number {
            font-weight: 700;
            color: #667eea;
        }

        .document-type {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .type-incoming {
            background: #d1ecf1;
            color: #0c5460;
        }

        .type-outgoing {
            background: #f8d7da;
            color: #721c24;
        }

        .document-content {
            font-size: 14px;
            line-height: 1.4;
        }

        .document-content .field {
            margin-bottom: 8px;
        }

        .document-content .label {
            font-weight: 600;
            color: var(--tg-theme-hint-color, #999999);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload-label:hover {
            border-color: #5a67d8;
            background: rgba(102, 126, 234, 0.1);
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .error-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã –û–±–ª—ñ–∫ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h1>
        <p>–°–∏—Å—Ç–µ–º–∞ –æ–±–ª—ñ–∫—É –≤—Ö—ñ–¥–Ω–æ—ó —Ç–∞ –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</p>
    </div>

    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-number" id="incomingCount">0</div>
            <div class="stat-label">–í—Ö—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="outgoingCount">0</div>
            <div class="stat-label">–í–∏—Ö—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</div>
        </div>
    </div>

    <div class="menu-grid">
        <button class="menu-item" onclick="showIncomingForm()">
            <span class="icon">üì•</span>
            <span class="title">–í—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è</span>
        </button>
        <button class="menu-item" onclick="showOutgoingForm()">
            <span class="icon">üì§</span>
            <span class="title">–í–∏—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è</span>
        </button>
        <button class="menu-item" onclick="showSearch()">
            <span class="icon">üîç</span>
            <span class="title">–ü–æ—à—É–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</span>
        </button>
        <button class="menu-item" onclick="showHelp()">
            <span class="icon">‚ÑπÔ∏è</span>
            <span class="title">–î–æ–≤—ñ–¥–∫–∞</span>
        </button>
    </div>

    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>

    <!-- –§–æ—Ä–º–∞ –≤—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó -->
    <div class="form-container" id="incomingForm">
        <h3>üì• –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h3>
        <form id="incomingFormData">
            <div class="form-group">
                <label for="inFromWhom">–í—ñ–¥ –∫–æ–≥–æ</label>
                <input type="text" id="inFromWhom" name="fromWhom" required 
                       placeholder="–ù–∞–∑–≤–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –∞–±–æ –æ—Å–æ–±–∏">
            </div>
            <div class="form-group">
                <label for="inSubject">–û–±'—î–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <input type="text" id="inSubject" name="subject" required 
                       placeholder="–¢–µ–º–∞ –∞–±–æ –ø—Ä–µ–¥–º–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            </div>
            <div class="form-group">
                <label for="inContent">–ó–º—ñ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <textarea id="inContent" name="content" required 
                          placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∑–º—ñ—Å—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label for="inDate">–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è</label>
                <input type="date" id="inDate" name="receivedDate" required>
            </div>
            <div class="form-group">
                <label for="inNotes">–ü—Ä–∏–º—ñ—Ç–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="inNotes" name="notes" 
                          placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label>–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <div class="file-upload">
                    <input type="file" id="inFile" name="file" accept=".pdf,.doc,.docx,.xlsx,.xls,.jpg,.png">
                    <label for="inFile" class="file-upload-label">
                        üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª
                    </label>
                </div>
            </div>
            <button type="submit" class="btn">‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
            <button type="button" class="btn btn-secondary" onclick="hideAllForms()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó -->
    <div class="form-container" id="outgoingForm">
        <h3>üì§ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h3>
        <form id="outgoingFormData">
            <div class="form-group">
                <label for="outToWhom">–ö–æ–º—É</label>
                <input type="text" id="outToWhom" name="toWhom" required 
                       placeholder="–ù–∞–∑–≤–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –∞–±–æ –æ—Å–æ–±–∏">
            </div>
            <div class="form-group">
                <label for="outSubject">–û–±'—î–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <input type="text" id="outSubject" name="subject" required 
                       placeholder="–¢–µ–º–∞ –∞–±–æ –ø—Ä–µ–¥–º–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            </div>
            <div class="form-group">
                <label for="outContent">–ó–º—ñ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <textarea id="outContent" name="content" required 
                          placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∑–º—ñ—Å—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label for="outDate">–î–∞—Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</label>
                <input type="date" id="outDate" name="sentDate" required>
            </div>
            <div class="form-group">
                <label for="outNotes">–ü—Ä–∏–º—ñ—Ç–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="outNotes" name="notes" 
                          placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label>–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <div class="file-upload">
                    <input type="file" id="outFile" name="file" accept=".pdf,.doc,.docx,.xlsx,.xls,.jpg,.png">
                    <label for="outFile" class="file-upload-label">
                        üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª
                    </label>
                </div>
            </div>
            <button type="submit" class="btn">‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
            <button type="button" class="btn btn-secondary" onclick="hideAllForms()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
    </div>

    <!-- –ü–æ—à—É–∫ -->
    <div class="search-container" id="searchContainer">
        <h3>üîç –ü–æ—à—É–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</h3>
        <div class="form-group">
            <label for="searchQuery">–ü–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç</label>
            <input type="text" id="searchQuery" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ—à—É–∫—É">
        </div>
        <button class="btn" onclick="performSearch()">üîç –ó–Ω–∞–π—Ç–∏</button>
        <button class="btn btn-secondary" onclick="hideAllForms()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
        
        <div class="search-results" id="searchResults"></div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>–û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö...</p>
    </div>

    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        const tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –≤ localStorage
        class DocumentDatabase {
            constructor() {
                this.incomingKey = 'correspondence_incoming';
                this.outgoingKey = 'correspondence_outgoing';
                this.counterKey = 'correspondence_counters';
            }

            getIncoming() {
                return JSON.parse(localStorage.getItem(this.incomingKey) || '[]');
            }

            getOutgoing() {
                return JSON.parse(localStorage.getItem(this.outgoingKey) || '[]');
            }

            getCounters() {
                return JSON.parse(localStorage.getItem(this.counterKey) || '{"incoming": 0, "outgoing": 0}');
            }

            saveIncoming(documents) {
                localStorage.setItem(this.incomingKey, JSON.stringify(documents));
            }

            saveOutgoing(documents) {
                localStorage.setItem(this.outgoingKey, JSON.stringify(documents));
            }

            saveCounters(counters) {
                localStorage.setItem(this.counterKey, JSON.stringify(counters));
            }

            generateDocNumber(type) {
                const counters = this.getCounters();
                const date = new Date();
                const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                
                counters[type]++;
                this.saveCounters(counters);
                
                const prefix = type === 'incoming' ? 'IN' : 'OUT';
                const number = String(counters[type]).padStart(3, '0');
                
                return `${prefix}-${dateStr}-${number}`;
            }

            addDocument(type, data) {
                const documents = type === 'incoming' ? this.getIncoming() : this.getOutgoing();
                const docNumber = this.generateDocNumber(type);
                
                const document = {
                    id: Date.now(),
                    docNumber,
                    ...data,
                    createdAt: new Date().toISOString()
                };

                documents.push(document);
                
                if (type === 'incoming') {
                    this.saveIncoming(documents);
                } else {
                    this.saveOutgoing(documents);
                }

                return document;
            }

            search(query) {
                const incoming = this.getIncoming();
                const outgoing = this.getOutgoing();
                const allDocs = [
                    ...incoming.map(doc => ({ ...doc, type: 'incoming' })),
                    ...outgoing.map(doc => ({ ...doc, type: 'outgoing' }))
                ];

                const lowerQuery = query.toLowerCase();
                return allDocs.filter(doc => {
                    return (
                        (doc.fromWhom && doc.fromWhom.toLowerCase().includes(lowerQuery)) ||
                        (doc.toWhom && doc.toWhom.toLowerCase().includes(lowerQuery)) ||
                        (doc.subject && doc.subject.toLowerCase().includes(lowerQuery)) ||
                        (doc.content && doc.content.toLowerCase().includes(lowerQuery)) ||
                        (doc.notes && doc.notes.toLowerCase().includes(lowerQuery)) ||
                        (doc.docNumber && doc.docNumber.toLowerCase().includes(lowerQuery))
                    );
                });
            }
        }

        const db = new DocumentDatabase();

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            setDefaultDates();
        });

        function updateStats() {
            const incoming = db.getIncoming();
            const outgoing = db.getOutgoing();
            
            document.getElementById('incomingCount').textContent = incoming.length;
            document.getElementById('outgoingCount').textContent = outgoing.length;
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const inDate = document.getElementById('inDate');
            const outDate = document.getElementById('outDate');
            
            if (inDate) inDate.value = today;
            if (outDate) outDate.value = today;
        }

        function showMessage(message, type = 'success') {
            const successEl = document.getElementById('successMessage');
            const errorEl = document.getElementById('errorMessage');
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            successEl.classList.remove('active');
            errorEl.classList.remove('active');
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω–µ
            if (type === 'success') {
                successEl.textContent = message;
                successEl.classList.add('active');
            } else {
                errorEl.textContent = message;
                errorEl.classList.add('active');
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                successEl.classList.remove('active');
                errorEl.classList.remove('active');
            }, 5000);
            
            // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –¥–æ –ø–æ—á–∞—Ç–∫—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function hideAllForms() {
            document.querySelectorAll('.form-container, .search-container').forEach(form => {
                form.classList.remove('active');
            });
        }

        function showIncomingForm() {
            hideAllForms();
            document.getElementById('incomingForm').classList.add('active');
            window.scrollTo({ top: document.getElementById('incomingForm').offsetTop - 20, behavior: 'smooth' });
        }

        function showOutgoingForm() {
            hideAllForms();
            document.getElementById('outgoingForm').classList.add('active');
            window.scrollTo({ top: document.getElementById('outgoingForm').offsetTop - 20, behavior: 'smooth' });
        }

        function showSearch() {
            hideAllForms();
            document.getElementById('searchContainer').classList.add('active');
            window.scrollTo({ top: document.getElementById('searchContainer').offsetTop - 20, behavior: 'smooth' });
        }

        function showHelp() {
            const helpText = `üìã –î–æ–≤—ñ–¥–∫–∞ –ø–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é —Å–∏—Å—Ç–µ–º–∏ –æ–±–ª—ñ–∫—É –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó

üì• –í—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è - —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
üì§ –í–∏—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è - —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤  
üîç –ü–æ—à—É–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ - –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –∑–∞ –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏

–ü—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤:
‚Ä¢ –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è
‚Ä¢ –ó–∞ –±–∞–∂–∞–Ω–Ω—è–º –ø—Ä–∏–∫—Ä—ñ–ø—ñ—Ç—å —Ñ–∞–π–ª
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä

–ü–æ—à—É–∫ –ø—Ä–∞—Ü—é—î –ø–æ –≤—Å—ñ—Ö –ø–æ–ª—è—Ö: –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó, —Ç–µ–º—ñ, –∑–º—ñ—Å—Ç—É, –ø—Ä–∏–º—ñ—Ç–∫–∞—Ö —Ç–∞ –Ω–æ–º–µ—Ä—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞.

–í—Å—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.`;
            
            if (tg && tg.showAlert) {
                tg.showAlert(helpText);
            } else {
                alert(helpText);
            }
        }

        // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º
        document.getElementById('incomingFormData').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading();

            try {
                const formData = new FormData(this);
                const data = {
                    fromWhom: formData.get('fromWhom'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    receivedDate: formData.get('receivedDate'),
                    notes: formData.get('notes') || '',
                    fileName: ''
                };

                // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É (—è–∫—â–æ —î)
                const file = formData.get('file');
                if (file && file.size > 0) {
                    data.fileName = file.name;
                    data.fileSize = file.size;
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º—É –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É —Ç—É—Ç –±–∏ –±—É–≤ –∫–æ–¥ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                }

                const document = db.addDocument('incoming', data);
                
                hideLoading();
                showMessage(`‚úÖ –í—Ö—ñ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ! –ù–æ–º–µ—Ä: ${document.docNumber}`);
                
                this.reset();
                setDefaultDates();
                updateStats();
                hideAllForms();

                // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—ñ—ó –≤ Telegram
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'document_registered',
                        type: 'incoming',
                        docNumber: document.docNumber
                    }));
                }
            } catch (error) {
                hideLoading();
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞', 'error');
                console.error(error);
            }
        });

        document.getElementById('outgoingFormData').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading();

            try {
                const formData = new FormData(this);
                const data = {
                    toWhom: formData.get('toWhom'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    sentDate: formData.get('sentDate'),
                    notes: formData.get('notes') || '',
                    fileName: ''
                };

                // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É (—è–∫—â–æ —î)
                const file = formData.get('file');
                if (file && file.size > 0) {
                    data.fileName = file.name;
                    data.fileSize = file.size;
                }

                const document = db.addDocument('outgoing', data);
                
                hideLoading();
                showMessage(`‚úÖ –í–∏—Ö—ñ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ! –ù–æ–º–µ—Ä: ${document.docNumber}`);
                
                this.reset();
                setDefaultDates();
                updateStats();
                hideAllForms();

                // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—ñ—ó –≤ Telegram
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'document_registered',
                        type: 'outgoing',
                        docNumber: document.docNumber
                    }));
                }
            } catch (error) {
                hideLoading();
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞', 'error');
                console.error(error);
            }
        });

        function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                showMessage('‚ö†Ô∏è –í–≤–µ–¥—ñ—Ç—å –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç', 'error');
                return;
            }

            showLoading();

            try {
                const results = db.search(query);
                
                const resultsContainer = document.getElementById('searchResults');
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <span style="font-size: 48px;">üîç</span>
                            <p>–ó–∞ –∑–∞–ø–∏—Ç–æ–º "${query}" –¥–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = `
                        <h4>–ó–Ω–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤: ${results.length}</h4>
                        ${results.map(doc => `
                            <div class="document-card">
                                <div class="document-header">
                                    <span class="document-number">${doc.docNumber}</span>
                                    <span class="document-type ${doc.type === 'incoming' ? 'type-incoming' : 'type-outgoing'}">
                                        ${doc.type === 'incoming' ? 'üì• –í—Ö—ñ–¥–Ω–∏–π' : 'üì§ –í–∏—Ö—ñ–¥–Ω–∏–π'}
                                    </span>
                                </div>
                                <div class="document-content">
                                    <div class="field">
                                        <span class="label">${doc.type === 'incoming' ? '–í—ñ–¥:' : '–ö–æ–º—É:'}</span>
                                        ${doc.fromWhom || doc.toWhom}
                                    </div>
                                    <div class="field">
                                        <span class="label">–¢–µ–º–∞:</span>
                                        ${doc.subject}
                                    </div>
                                    <div class="field">
                                        <span class="label">–ó–º—ñ—Å—Ç:</span>
                                        ${doc.content.length > 100 ? doc.content.substring(0, 100) + '...' : doc.content}
                                    </div>
                                    <div class="field">
                                        <span class="label">–î–∞—Ç–∞:</span>
                                        ${doc.receivedDate || doc.sentDate}
                                    </div>
                                    ${doc.fileName ? `
                                        <div class="field">
                                            <span class="label">üìé –§–∞–π–ª:</span>
                                            ${doc.fileName}
                                        </div>
                                    ` : ''}
                                    ${doc.notes ? `
                                        <div class="field">
                                            <span class="label">–ü—Ä–∏–º—ñ—Ç–∫–∏:</span>
                                            ${doc.notes}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ—à—É–∫—É', 'error');
                console.error(error);
            }
        }

        // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—ñ–≤
        document.getElementById('inFile').addEventListener('change', function(e) {
            const label = document.querySelector('label[for="inFile"]');
            if (e.target.files.length > 0) {
                label.textContent = `üìé ${e.target.files[0].name}`;
            } else {
                label.textContent = 'üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª';
            }
        });

        document.getElementById('outFile').addEventListener('change', function(e) {
            const label = document.querySelector('label[for="outFile"]');
            if (e.target.files.length > 0) {
                label.textContent = `üìé ${e.target.files[0].name}`;
            } else {
                label.textContent = 'üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª';
            }
        });

        // –ü–æ—à—É–∫ –ø–æ Enter
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è Telegram
        if (tg) {
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä–æ–≤–æ—ó —Å—Ö–µ–º–∏
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f8f9fa');

            // –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
            tg.onEvent('backButtonClicked', function() {
                if (document.querySelector('.form-container.active') || document.querySelector('.search-container.active')) {
                    hideAllForms();
                    tg.BackButton.hide();
                } else {
                    tg.close();
                }
            });

            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Ñ–æ—Ä–º
            function showBackButton() {
                tg.BackButton.show();
            }

            // –û–Ω–æ–≤–ª—é—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó –ø–æ–∫–∞–∑—É —Ñ–æ—Ä–º
            const originalShowIncoming = showIncomingForm;
            const originalShowOutgoing = showOutgoingForm;
            const originalShowSearch = showSearch;

            showIncomingForm = function() {
                originalShowIncoming();
                if (tg) showBackButton();
            };

            showOutgoingForm = function() {
                originalShowOutgoing();
                if (tg) showBackButton();
            };

            showSearch = function() {
                originalShowSearch();
                if (tg) showBackButton();
            };

            const originalHideAllForms = hideAllForms;
            hideAllForms = function() {
                originalHideAllForms();
                if (tg) tg.BackButton.hide();
            };

            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è MainButton –¥–ª—è —Ñ–æ—Ä–º
            function setupMainButton(text, callback) {
                if (tg.MainButton) {
                    tg.MainButton.setText(text);
                    tg.MainButton.show();
                    tg.MainButton.onClick(callback);
                }
            }

            // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ MainButton
            function hideMainButton() {
                if (tg.MainButton) {
                    tg.MainButton.hide();
                    tg.MainButton.offClick();
                }
            }
        }

        // –ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö (–¥–æ–¥–∞—Ç–∫–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è)
        function exportData() {
            const incoming = db.getIncoming();
            const outgoing = db.getOutgoing();
            
            const data = {
                incoming,
                outgoing,
                exportDate: new Date().toISOString(),
                totalDocuments: incoming.length + outgoing.length
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `correspondence_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('‚úÖ –î–∞–Ω—ñ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
        }

        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É (–º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤ –º–µ–Ω—é)
        function addExportButton() {
            const menuGrid = document.querySelector('.menu-grid');
            const exportButton = document.createElement('button');
            exportButton.className = 'menu-item';
            exportButton.innerHTML = `
                <span class="icon">üíæ</span>
                <span class="title">–ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö</span>
            `;
            exportButton.onclick = exportData;
            menuGrid.appendChild(exportButton);
        }

        // –†–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—è–¥–æ–∫, —è–∫—â–æ —Ö–æ—á–µ—Ç–µ –∫–Ω–æ–ø–∫—É –µ–∫—Å–ø–æ—Ä—Ç—É
        // addExportButton();

        // –î–µ–º–æ-–¥–∞–Ω—ñ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è (–º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏)
        function addDemoData() {
            if (db.getIncoming().length === 0 && db.getOutgoing().length === 0) {
                // –î–æ–¥–∞—î–º–æ –¥–µ–º–æ –≤—Ö—ñ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
                db.addDocument('incoming', {
                    fromWhom: '–ú—ñ–Ω—ñ—Å—Ç–µ—Ä—Å—Ç–≤–æ –æ—Å–≤—ñ—Ç–∏ —ñ –Ω–∞—É–∫–∏ –£–∫—Ä–∞—ó–Ω–∏',
                    subject: '–©–æ–¥–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∞—Ç–µ—Å—Ç–∞—Ü—ñ—ó',
                    content: '–Ü–Ω—Ñ–æ—Ä–º—É—î–º–æ –ø—Ä–æ —Ç–µ—Ä–º—ñ–Ω–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∞—Ç–µ—Å—Ç–∞—Ü—ñ—ó –ø–µ–¥–∞–≥–æ–≥—ñ—á–Ω–∏—Ö –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤',
                    receivedDate: '2024-09-01',
                    notes: '–¢–µ—Ä–º—ñ–Ω–æ–≤–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ 15.09.2024'
                });

                // –î–æ–¥–∞—î–º–æ –¥–µ–º–æ –≤–∏—Ö—ñ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
                db.addDocument('outgoing', {
                    toWhom: '–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –æ—Å–≤—ñ—Ç–∏ —Ç–∞ –Ω–∞—É–∫–∏',
                    subject: '–ó–≤—ñ—Ç –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω—É —Ä–æ–±–æ—Ç—É',
                    content: '–ü–æ–¥–∞—î–º–æ –∑–≤—ñ—Ç –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω—É —Ä–æ–±–æ—Ç—É –∑–∞ —Å–µ—Ä–ø–µ–Ω—å 2024 —Ä–æ–∫—É',
                    sentDate: '2024-09-05',
                    notes: '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—é –ø–æ—à—Ç–æ—é'
                });

                updateStats();
            }
        }

        // –†–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–µ–º–æ-–¥–∞–Ω–∏—Ö –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É
        // addDemoData();
    </script>
</body>
</html>
