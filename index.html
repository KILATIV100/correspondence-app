<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±–ª—ñ–∫ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª—ñ –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ */
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã –û–±–ª—ñ–∫ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h1>
        <p>–°–∏—Å—Ç–µ–º–∞ –æ–±–ª—ñ–∫—É –≤—Ö—ñ–¥–Ω–æ—ó —Ç–∞ –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</p>
    </div>

    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-number" id="incomingCount">0</div>
            <div class="stat-label">–í—Ö—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="outgoingCount">0</div>
            <div class="stat-label">–í–∏—Ö—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</div>
        </div>
    </div>

    <div class="menu-grid">
        <button class="menu-item" onclick="showIncomingForm()">
            <span class="icon">üì•</span>
            <span class="title">–í—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è</span>
        </button>
        <button class="menu-item" onclick="showOutgoingForm()">
            <span class="icon">üì§</span>
            <span class="title">–í–∏—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è</span>
        </button>
        <button class="menu-item" onclick="showSearch()">
            <span class="icon">üîç</span>
            <span class="title">–ü–æ—à—É–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</span>
        </button>
        <button class="menu-item" onclick="showHelp()">
            <span class="icon">‚ÑπÔ∏è</span>
            <span class="title">–î–æ–≤—ñ–¥–∫–∞</span>
        </button>
    </div>

    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>

    <!-- –§–æ—Ä–º–∞ –≤—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó -->
    <div class="form-container" id="incomingForm">
        <h3>üì• –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h3>
        <form id="incomingFormData">
            <div class="form-group">
                <label for="inFromWhom">–í—ñ–¥ –∫–æ–≥–æ</label>
                <input type="text" id="inFromWhom" name="fromWhom" required placeholder="–ù–∞–∑–≤–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –∞–±–æ –æ—Å–æ–±–∏">
            </div>
            <div class="form-group">
                <label for="inSubject">–û–±'—î–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <input type="text" id="inSubject" name="subject" required placeholder="–¢–µ–º–∞ –∞–±–æ –ø—Ä–µ–¥–º–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            </div>
            <div class="form-group">
                <label for="inContent">–ó–º—ñ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <textarea id="inContent" name="content" required placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∑–º—ñ—Å—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label for="inDate">–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è</label>
                <input type="date" id="inDate" name="receivedDate" required>
            </div>
            <div class="form-group">
                <label for="registeredBy">–•—Ç–æ —Ä–µ—î—Å—Ç—Ä—É—î –¥–æ–∫—É–º–µ–Ω—Ç</label>
                <input type="text" id="registeredBy" name="registeredBy" required placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è">
            </div>
            <div class="form-group">
                <label for="inNotes">–ü—Ä–∏–º—ñ—Ç–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="inNotes" name="notes" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label>–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <div class="file-upload">
                    <input type="file" id="inFile" name="file" accept=".pdf,.doc,.docx,.xlsx,.xls,.jpg,.png">
                    <label for="inFile" class="file-upload-label">üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</label>
                </div>
            </div>
            <button type="submit" class="btn">‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
            <button type="button" class="btn btn-secondary" onclick="hideAllForms()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó -->
    <div class="form-container" id="outgoingForm">
        <h3>üì§ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h3>
        <form id="outgoingFormData">
            <div class="form-group">
                <label for="outToWhom">–ö–æ–º—É</label>
                <input type="text" id="outToWhom" name="toWhom" required placeholder="–ù–∞–∑–≤–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –∞–±–æ –æ—Å–æ–±–∏">
            </div>
            <div class="form-group">
                <label for="outSubject">–û–±'—î–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <input type="text" id="outSubject" name="subject" required placeholder="–¢–µ–º–∞ –∞–±–æ –ø—Ä–µ–¥–º–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            </div>
            <div class="form-group">
                <label for="outContent">–ó–º—ñ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <textarea id="outContent" name="content" required placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∑–º—ñ—Å—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label for="outDate">–î–∞—Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</label>
                <input type="date" id="outDate" name="sentDate" required>
            </div>
            <div class="form-group">
                <label for="outNotes">–ü—Ä–∏–º—ñ—Ç–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="outNotes" name="notes" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label>–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <div class="file-upload">
                    <input type="file" id="outFile" name="file" accept=".pdf,.doc,.docx,.xlsx,.xls,.jpg,.png">
                    <label for="outFile" class="file-upload-label">üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</label>
                </div>
            </div>
            <button type="submit" class="btn">‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
            <button type="button" class="btn btn-secondary" onclick="hideAllForms()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
    </div>

    <!-- –ü–æ—à—É–∫ -->
    <div class="search-container" id="searchContainer">
        <h3>üîç –ü–æ—à—É–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</h3>
        <div class="form-group">
            <label for="searchQuery">–ü–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç</label>
            <input type="text" id="searchQuery" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ—à—É–∫—É">
        </div>
        <button class="btn" onclick="performSearch('incoming')">üîç –ü–æ—à—É–∫ –ø–æ –≤—Ö—ñ–¥–Ω—ñ–π</button>
        <button class="btn" onclick="performSearch('outgoing')">üîç –ü–æ—à—É–∫ –ø–æ –≤–∏—Ö—ñ–¥–Ω—ñ–π</button>
        <button class="btn btn-secondary" onclick="hideAllForms()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
        
        <div class="search-results" id="searchResults"></div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>–û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö...</p>
    </div>

    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        const tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –≤ localStorage
        class DocumentDatabase {
            constructor() {
                this.incomingKey = 'correspondence_incoming';
                this.outgoingKey = 'correspondence_outgoing';
                this.counterKey = 'correspondence_counters';
            }

            getIncoming() {
                return JSON.parse(localStorage.getItem(this.incomingKey) || '[]');
            }

            getOutgoing() {
                return JSON.parse(localStorage.getItem(this.outgoingKey) || '[]');
            }

            getCounters() {
                return JSON.parse(localStorage.getItem(this.counterKey) || '{"incoming": 0, "outgoing": 0}');
            }

            saveIncoming(documents) {
                localStorage.setItem(this.incomingKey, JSON.stringify(documents));
            }

            saveOutgoing(documents) {
                localStorage.setItem(this.outgoingKey, JSON.stringify(documents));
            }

            saveCounters(counters) {
                localStorage.setItem(this.counterKey, JSON.stringify(counters));
            }

            generateDocNumber(type) {
                const counters = this.getCounters();
                const date = new Date();
                const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                
                counters[type]++;
                this.saveCounters(counters);
                
                const prefix = type === 'incoming' ? 'IN' : 'OUT';
                const number = String(counters[type]).padStart(3, '0');
                
                return `${prefix}-${dateStr}-${number}`;
            }

            addDocument(type, data) {
                const documents = type === 'incoming' ? this.getIncoming() : this.getOutgoing();
                const docNumber = this.generateDocNumber(type);
                
                const document = {
                    id: Date.now(),
                    docNumber,
                    ...data,
                    createdAt: new Date().toISOString()
                };

                documents.push(document);
                
                if (type === 'incoming') {
                    this.saveIncoming(documents);
                } else {
                    this.saveOutgoing(documents);
                }

                return document;
            }

            search(query, type) {
                const incoming = this.getIncoming();
                const outgoing = this.getOutgoing();
                const allDocs = type === 'incoming' 
                    ? incoming 
                    : type === 'outgoing' 
                    ? outgoing 
                    : [...incoming, ...outgoing];

                const lowerQuery = query.toLowerCase();
                return allDocs.filter(doc => {
                    return (
                        (doc.fromWhom && doc.fromWhom.toLowerCase().includes(lowerQuery)) ||
                        (doc.toWhom && doc.toWhom.toLowerCase().includes(lowerQuery)) ||
                        (doc.subject && doc.subject.toLowerCase().includes(lowerQuery)) ||
                        (doc.content && doc.content.toLowerCase().includes(lowerQuery)) ||
                        (doc.notes && doc.notes.toLowerCase().includes(lowerQuery)) ||
                        (doc.docNumber && doc.docNumber.toLowerCase().includes(lowerQuery))
                    );
                });
            }
        }

        const db = new DocumentDatabase();

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            setDefaultDates();
        });

        function updateStats() {
            const incoming = db.getIncoming();
            const outgoing = db.getOutgoing();
            
            document.getElementById('incomingCount').textContent = incoming.length;
            document.getElementById('outgoingCount').textContent = outgoing.length;
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const inDate = document.getElementById('inDate');
            const outDate = document.getElementById('outDate');
            
            if (inDate) inDate.value = today;
            if (outDate) outDate.value = today;
        }

        function showMessage(message, type = 'success') {
            const successEl = document.getElementById('successMessage');
            const errorEl = document.getElementById('errorMessage');
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            successEl.classList.remove('active');
            errorEl.classList.remove('active');
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω–µ
            if (type === 'success') {
                successEl.textContent = message;
                successEl.classList.add('active');
            } else {
                errorEl.textContent = message;
                errorEl.classList.add('active');
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                successEl.classList.remove('active');
                errorEl.classList.remove('active');
            }, 5000);
            
            // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –¥–æ –ø–æ—á–∞—Ç–∫—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function hideAllForms() {
            document.querySelectorAll('.form-container, .search-container').forEach(form => {
                form.classList.remove('active');
            });
        }

        function showIncomingForm() {
            hideAllForms();
            document.getElementById('incomingForm').classList.add('active');
            window.scrollTo({ top: document.getElementById('incomingForm').offsetTop - 20, behavior: 'smooth' });
        }

        function showOutgoingForm() {
            hideAllForms();
            document.getElementById('outgoingForm').classList.add('active');
            window.scrollTo({ top: document.getElementById('outgoingForm').offsetTop - 20, behavior: 'smooth' });
        }

        function showSearch() {
            hideAllForms();
            document.getElementById('searchContainer').classList.add('active');
            window.scrollTo({ top: document.getElementById('searchContainer').offsetTop - 20, behavior: 'smooth' });
        }

        function showHelp() {
            const helpText = `üìã **–î–æ–≤—ñ–¥–∫–∞ –ø–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é —Å–∏—Å—Ç–µ–º–∏ –æ–±–ª—ñ–∫—É –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó**

üì• **–í—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è** - —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤  
üì§ **–í–∏—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è** - —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤  
üîç **–ü–æ—à—É–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤** - –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –∑–∞ –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏

–ü—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤:
‚Ä¢ –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è  
‚Ä¢ –ó–∞ –±–∞–∂–∞–Ω–Ω—è–º –ø—Ä–∏–∫—Ä—ñ–ø—ñ—Ç—å —Ñ–∞–π–ª  
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä

**–Ø–∫ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Ñ–∞–π–ª–∏:**
- –ü—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤, –≤–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –≤–∞—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó.  
- –§–∞–π–ª–∏ –º–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏, –Ω–∞—Ç–∏—Å–Ω—É–≤—à–∏ –Ω–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏" —É —Ç–∞–±–ª–∏—Ü—ñ.
            `;
            if (tg && tg.showAlert) {
                tg.showAlert(helpText);
            } else {
                alert(helpText);
            }
        }

        // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º
        document.getElementById('incomingFormData').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading();

            try {
                const formData = new FormData(this);
                const data = {
                    fromWhom: formData.get('fromWhom'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    receivedDate: formData.get('receivedDate'),
                    registeredBy: formData.get('registeredBy'),
                    notes: formData.get('notes') || '',
                    fileName: ''
                };

                // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É (—è–∫—â–æ —î)
                const file = formData.get('file');
                if (file && file.size > 0) {
                    data.fileName = file.name;
                    data.fileSize = file.size;
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º—É –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É —Ç—É—Ç –±–∏ –±—É–≤ –∫–æ–¥ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                }

                const document = db.addDocument('incoming', data);
                
                hideLoading();
                showMessage(`‚úÖ –í—Ö—ñ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ! –ù–æ–º–µ—Ä: ${document.docNumber}`);
                
                this.reset();
                setDefaultDates();
                updateStats();
                hideAllForms();

                // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—ñ—ó –≤ Telegram
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'document_registered',
                        type: 'incoming',
                        docNumber: document.docNumber
                    }));
                }
            } catch (error) {
                hideLoading();
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞', 'error');
                console.error(error);
            }
        });

        document.getElementById('outgoingFormData').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading();

            try {
                const formData = new FormData(this);
                const data = {
                    toWhom: formData.get('toWhom'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    sentDate: formData.get('sentDate'),
                    registeredBy: formData.get('registeredBy'),
                    notes: formData.get('notes') || '',
                    fileName: ''
                };

                // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É (—è–∫—â–æ —î)
                const file = formData.get('file');
                if (file && file.size > 0) {
                    data.fileName = file.name;
                    data.fileSize = file.size;
                }

                const document = db.addDocument('outgoing', data);
                
                hideLoading();
                showMessage(`‚úÖ –í–∏—Ö—ñ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ! –ù–æ–º–µ—Ä: ${document.docNumber}`);
                
                this.reset();
                setDefaultDates();
                updateStats();
                hideAllForms();

                // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—ñ—ó –≤ Telegram
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'document_registered',
                        type: 'outgoing',
                        docNumber: document.docNumber
                    }));
                }
            } catch (error) {
                hideLoading();
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞', 'error');
                console.error(error);
            }
        });

        function performSearch(type) {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                showMessage('‚ö†Ô∏è –í–≤–µ–¥—ñ—Ç—å –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç', 'error');
                return;
            }

            showLoading();

            try {
                const results = db.search(query, type);
                
                const resultsContainer = document.getElementById('searchResults');
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <span style="font-size: 48px;">üîç</span>
                            <p>–ó–∞ –∑–∞–ø–∏—Ç–æ–º "${query}" –¥–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = `
                        <h4>–ó–Ω–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤: ${results.length}</h4>
                        ${results.map(doc => `
                            <div class="document-card">
                                <div class="document-header">
                                    <span class="document-number">${doc.docNumber}</span>
                                    <span class="document-type ${doc.type === 'incoming' ? 'type-incoming' : 'type-outgoing'}">
                                        ${doc.type === 'incoming' ? 'üì• –í—Ö—ñ–¥–Ω–∏–π' : 'üì§ –í–∏—Ö—ñ–¥–Ω–∏–π'}
                                    </span>
                                </div>
                                <div class="document-content">
                                    <div class="field">
                                        <span class="label">${doc.type === 'incoming' ? '–í—ñ–¥:' : '–ö–æ–º—É:'}</span>
                                        ${doc.fromWhom || doc.toWhom}
                                    </div>
                                    <div class="field">
                                        <span class="label">–¢–µ–º–∞:</span>
                                        ${doc.subject}
                                    </div>
                                    <div class="field">
                                        <span class="label">–ó–º—ñ—Å—Ç:</span>
                                        ${doc.content.length > 100 ? doc.content.substring(0, 100) + '...' : doc.content}
                                    </div>
                                    <div class="field">
                                        <span class="label">–î–∞—Ç–∞:</span>
                                        ${doc.receivedDate || doc.sentDate}
                                    </div>
                                    ${doc.fileName ? `
                                        <div class="field">
                                            <span class="label">üìé –§–∞–π–ª:</span>
                                            ${doc.fileName}
                                        </div>
                                    ` : ''}
                                    ${doc.notes ? `
                                        <div class="field">
                                            <span class="label">–ü—Ä–∏–º—ñ—Ç–∫–∏:</span>
                                            ${doc.notes}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ—à—É–∫—É', 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
