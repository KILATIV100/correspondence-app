<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±–ª—ñ–∫ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.5;
            padding: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .menu-item {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border: none;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .menu-item .icon {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .menu-item .title {
            font-size: 14px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-container {
            display: none;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-container.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .table-container {
            display: none;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-height: 70vh;
            overflow-y: auto;
        }

        .table-container.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .doc-number-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 700;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #6c757d);
            color: var(--tg-theme-text-color, #ffffff);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            margin: 2px;
        }

        .search-container {
            display: none;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .search-container.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .search-tabs {
            display: flex;
            margin-bottom: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            overflow: hidden;
        }

        .search-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .search-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .search-results {
            margin-top: 20px;
        }

        .document-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .document-table th,
        .document-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .document-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .document-table td {
            font-size: 13px;
            max-width: 200px;
            word-wrap: break-word;
        }

        .document-table .actions {
            white-space: nowrap;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .document-number {
            font-weight: 700;
            color: #667eea;
        }

        .document-type {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .type-incoming {
            background: #d1ecf1;
            color: #0c5460;
        }

        .type-outgoing {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload-label:hover {
            border-color: #5a67d8;
            background: rgba(102, 126, 234, 0.1);
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .help-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .help-section {
            margin-bottom: 24px;
        }

        .help-section h4 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .help-section p, .help-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .help-section ul {
            padding-left: 20px;
        }

        .file-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .file-link:hover {
            text-decoration: underline;
        }

        .no-files {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã –û–±–ª—ñ–∫ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h1>
        <p>–°–∏—Å—Ç–µ–º–∞ –æ–±–ª—ñ–∫—É –≤—Ö—ñ–¥–Ω–æ—ó —Ç–∞ –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</p>
    </div>

    <div class="stats-container">
        <div class="stat-card" onclick="showIncomingTable()">
            <div class="stat-number" id="incomingCount">0</div>
            <div class="stat-label">–í—Ö—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</div>
        </div>
        <div class="stat-card" onclick="showOutgoingTable()">
            <div class="stat-number" id="outgoingCount">0</div>
            <div class="stat-label">–í–∏—Ö—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏</div>
        </div>
    </div>

    <div class="menu-grid">
        <button class="menu-item" onclick="showIncomingForm()">
            <span class="icon">üì•</span>
            <span class="title">–ù–æ–≤–∞ –≤—Ö—ñ–¥–Ω–∞</span>
        </button>
        <button class="menu-item" onclick="showOutgoingForm()">
            <span class="icon">üì§</span>
            <span class="title">–ù–æ–≤–∞ –≤–∏—Ö—ñ–¥–Ω–∞</span>
        </button>
        <button class="menu-item" onclick="showSearch()">
            <span class="icon">üîç</span>
            <span class="title">–ü–æ—à—É–∫</span>
        </button>
        <button class="menu-item" onclick="showHelp()">
            <span class="icon">‚ÑπÔ∏è</span>
            <span class="title">–î–æ–≤—ñ–¥–∫–∞</span>
        </button>
    </div>

    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>

    <!-- –¢–∞–±–ª–∏—Ü—è –≤—Ö—ñ–¥–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ -->
    <div class="table-container" id="incomingTable">
        <h3>üì• –í—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è</h3>
        <div class="export-section">
            <button class="btn btn-secondary" onclick="exportIncoming()">üìä –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        </div>
        <div id="incomingTableContent"></div>
        <button class="btn btn-secondary" onclick="hideAllForms()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü—è –≤–∏—Ö—ñ–¥–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ -->
    <div class="table-container" id="outgoingTable">
        <h3>üì§ –í–∏—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è</h3>
        <div class="export-section">
            <button class="btn btn-secondary" onclick="exportOutgoing()">üìä –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        </div>
        <div id="outgoingTableContent"></div>
        <button class="btn btn-secondary" onclick="hideAllForms()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó -->
    <div class="form-container" id="incomingForm">
        <h3>üì• –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h3>
        <div class="doc-number-display" id="incomingDocNumber"></div>
        <form id="incomingFormData">
            <div class="form-group">
                <label for="inRegistrar">–•—Ç–æ —Ä–µ—î—Å—Ç—Ä—É—î –¥–æ–∫—É–º–µ–Ω—Ç</label>
                <input type="text" id="inRegistrar" name="registrar" required 
                       placeholder="–ü.–Ü.–ë. –æ—Å–æ–±–∏, —â–æ —Ä–µ—î—Å—Ç—Ä—É—î –¥–æ–∫—É–º–µ–Ω—Ç">
            </div>
            <div class="form-group">
                <label for="inFromWhom">–í—ñ–¥ –∫–æ–≥–æ</label>
                <input type="text" id="inFromWhom" name="fromWhom" required 
                       placeholder="–ù–∞–∑–≤–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –∞–±–æ –æ—Å–æ–±–∏">
            </div>
            <div class="form-group">
                <label for="inSubject">–û–±'—î–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <input type="text" id="inSubject" name="subject" required 
                       placeholder="–¢–µ–º–∞ –∞–±–æ –ø—Ä–µ–¥–º–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            </div>
            <div class="form-group">
                <label for="inContent">–ó–º—ñ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <textarea id="inContent" name="content" required 
                          placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∑–º—ñ—Å—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label for="inDate">–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è</label>
                <input type="date" id="inDate" name="receivedDate" required>
            </div>
            <div class="form-group">
                <label for="inNotes">–ü—Ä–∏–º—ñ—Ç–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="inNotes" name="notes" 
                          placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label>–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <div class="file-upload">
                    <input type="file" id="inFile" name="file" accept=".pdf,.doc,.docx,.xlsx,.xls,.jpg,.png">
                    <label for="inFile" class="file-upload-label">
                        üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª
                    </label>
                </div>
            </div>
            <button type="submit" class="btn">‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
            <button type="button" class="btn btn-secondary" onclick="hideAllForms()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó -->
    <div class="form-container" id="outgoingForm">
        <h3>üì§ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤–∏—Ö—ñ–¥–Ω–æ—ó –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó</h3>
        <div class="doc-number-display" id="outgoingDocNumber"></div>
        <form id="outgoingFormData">
            <div class="form-group">
                <label for="outRegistrar">–•—Ç–æ —Ä–µ—î—Å—Ç—Ä—É—î –¥–æ–∫—É–º–µ–Ω—Ç</label>
                <input type="text" id="outRegistrar" name="registrar" required 
                       placeholder="–ü.–Ü.–ë. –æ—Å–æ–±–∏, —â–æ —Ä–µ—î—Å—Ç—Ä—É—î –¥–æ–∫—É–º–µ–Ω—Ç">
            </div>
            <div class="form-group">
                <label for="outToWhom">–ö–æ–º—É</label>
                <input type="text" id="outToWhom" name="toWhom" required 
                       placeholder="–ù–∞–∑–≤–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –∞–±–æ –æ—Å–æ–±–∏">
            </div>
            <div class="form-group">
                <label for="outSubject">–û–±'—î–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <input type="text" id="outSubject" name="subject" required 
                       placeholder="–¢–µ–º–∞ –∞–±–æ –ø—Ä–µ–¥–º–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            </div>
            <div class="form-group">
                <label for="outContent">–ó–º—ñ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                <textarea id="outContent" name="content" required 
                          placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∑–º—ñ—Å—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label for="outDate">–î–∞—Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</label>
                <input type="date" id="outDate" name="sentDate" required>
            </div>
            <div class="form-group">
                <label for="outNotes">–ü—Ä–∏–º—ñ—Ç–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="outNotes" name="notes" 
                          placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            </div>
            <div class="form-group">
                <label>–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <div class="file-upload">
                    <input type="file" id="outFile" name="file" accept=".pdf,.doc,.docx,.xlsx,.xls,.jpg,.png">
                    <label for="outFile" class="file-upload-label">
                        üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª
                    </label>
                </div>
            </div>
            <button type="submit" class="btn">‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
            <button type="button" class="btn btn-secondary" onclick="hideAllForms()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
    </div>

    <!-- –ü–æ—à—É–∫ -->
    <div class="search-container" id="searchContainer">
        <h3>üîç –ü–æ—à—É–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</h3>
        
        <div class="search-tabs">
            <button class="search-tab active" onclick="setSearchType('all')">–í—Å—ñ</button>
            <button class="search-tab" onclick="setSearchType('incoming')">üì• –í—Ö—ñ–¥–Ω—ñ</button>
            <button class="search-tab" onclick="setSearchType('outgoing')">üì§ –í–∏—Ö—ñ–¥–Ω—ñ</button>
        </div>

        <div class="form-group">
            <label for="searchQuery">–ü–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç</label>
            <input type="text" id="searchQuery" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ—à—É–∫—É">
        </div>
        <button class="btn" onclick="performSearch()">üîç –ó–Ω–∞–π—Ç–∏</button>
        <button class="btn btn-secondary" onclick="hideAllForms()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
        
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- –î–æ–≤—ñ–¥–∫–∞ -->
    <div class="form-container" id="helpContainer">
        <h3>‚ÑπÔ∏è –î–æ–≤—ñ–¥–∫–∞ –ø–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é</h3>
        
        <div class="help-content">
            <div class="help-section">
                <h4>üìã –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</h4>
                <ul>
                    <li><strong>üì• –ù–æ–≤–∞ –≤—Ö—ñ–¥–Ω–∞</strong> - —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</li>
                    <li><strong>üì§ –ù–æ–≤–∞ –≤–∏—Ö—ñ–¥–Ω–∞</strong> - —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</li>
                    <li><strong>üîç –ü–æ—à—É–∫</strong> - –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –∑–∞ –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏</li>
                    <li><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong> - –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —Ü–∏—Ñ—Ä–∏ –≤–≥–æ—Ä—ñ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –≤—Å—ñ—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</li>
                </ul>
            </div>

            <div class="help-section">
                <h4>üìù –Ø–∫ —Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏</h4>
                <p>1. <strong>–ù–æ–º–µ—Ä –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</strong> - –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ä–º–∏ –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</p>
                <p>2. <strong>–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è:</strong></p>
                <ul>
                    <li>–•—Ç–æ —Ä–µ—î—Å—Ç—Ä—É—î –¥–æ–∫—É–º–µ–Ω—Ç (–≤–∞—à–µ –ü.–Ü.–ë.)</li>
                    <li>–í—ñ–¥ –∫–æ–≥–æ/–ö–æ–º—É</li>
                    <li>–û–±'—î–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</li>
                    <li>–ó–º—ñ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</li>
                    <li>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è/–≤—ñ–¥–ø—Ä–∞–≤–∫–∏</li>
                </ul>
                <p>3. <strong>–ó–∞ –±–∞–∂–∞–Ω–Ω—è–º:</strong> –¥–æ–¥–∞–π—Ç–µ –ø—Ä–∏–º—ñ—Ç–∫–∏ —Ç–∞ –ø—Ä–∏–∫—Ä—ñ–ø—ñ—Ç—å —Ñ–∞–π–ª</p>
                <p>4. <strong>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç"</strong></p>
            </div>

            <div class="help-section">
                <h4>üîç –Ø–∫ —à—É–∫–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏</h4>
                <p>–ü–æ—à—É–∫ –ø—Ä–∞—Ü—é—î –∑–∞ –≤—Å—ñ–º–∞ –ø–æ–ª—è–º–∏:</p>
                <ul>
                    <li>–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</li>
                    <li>–í—ñ–¥ –∫–æ–≥–æ/–ö–æ–º—É</li>
                    <li>–¢–µ–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</li>
                    <li>–ó–º—ñ—Å—Ç</li>
                    <li>–ü—Ä–∏–º—ñ—Ç–∫–∏</li>
                    <li>–ü.–Ü.–ë. —Ä–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä–∞</li>
                </ul>
                <p>–ú–æ–∂–Ω–∞ —à—É–∫–∞—Ç–∏ –æ–∫—Ä–µ–º–æ –ø–æ –≤—Ö—ñ–¥–Ω—ñ–π –∞–±–æ –≤–∏—Ö—ñ–¥–Ω—ñ–π –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—ó, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –≤–∫–ª–∞–¥–∫–∏.</p>
            </div>

            <div class="help-section">
                <h4>üìÅ –î–µ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏</h4>
                <p><strong>–í–∞–∂–ª–∏–≤–æ:</strong> –§–∞–π–ª–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.</p>
                <p><strong>–î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ñ–∞–π–ª—ñ–≤:</strong></p>
                <ul>
                    <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —Ü–∏—Ñ—Ä—É –≤—Ö—ñ–¥–Ω–∏—Ö –∞–±–æ –≤–∏—Ö—ñ–¥–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –≤–≥–æ—Ä—ñ</li>
                    <li>–í—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü—è –∑ —É—Å—ñ–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏</li>
                    <li>–£ –∫–æ–ª–æ–Ω—Ü—ñ "–§–∞–π–ª–∏" –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "üìé –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏" –∞–±–æ "‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏"</li>
                </ul>
                <p><strong>–ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö:</strong> –í –∫–æ–∂–Ω—ñ–π —Ç–∞–±–ª–∏—Ü—ñ —î –∫–Ω–æ–ø–∫–∞ "üìä –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel" –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Excel-—Ñ–∞–π–ª—É –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º–∏ –Ω–∞ —Ñ–∞–π–ª–∏</p>
            </div>

            <div class="help-section">
                <h4>üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</h4>
                <p>–í—Å—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ. –¶–µ –æ–∑–Ω–∞—á–∞—î:</p>
                <ul>
                    <li>‚úÖ –®–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –≤–∞—à–∏—Ö –¥–∞–Ω–∏—Ö</li>
                    <li>‚úÖ –ü—Ä–∞—Ü—é—î –±–µ–∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É (–ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)</li>
                    <li>‚ö†Ô∏è –î–∞–Ω—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ –≤ —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ –Ω–∞ —Ü—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó</li>
                    <li>‚ö†Ô∏è –û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–∞–ª–∏—Ç—å –¥–∞–Ω—ñ</li>
                </ul>
                <p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:</strong> –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ–±—ñ—Ç—å –µ–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è</p>
            </div>

            <div class="help-section">
                <h4>üÜò –ü—ñ–¥—Ç—Ä–∏–º–∫–∞</h4>
                <p>–Ø–∫—â–æ —É –≤–∞—Å –≤–∏–Ω–∏–∫–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –ø—Ä–æ–±–ª–µ–º–∏:</p>
                <ul>
                    <li>–°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É</li>
                    <li>–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –≤—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è</li>
                    <li>–î–ª—è —Ñ–∞–π–ª—ñ–≤: –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è PDF, DOC, DOCX, XLS, XLSX, JPG, PNG</li>
                </ul>
            </div>
        </div>

        <button class="btn btn-secondary" onclick="hideAllForms()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏ –¥–æ–≤—ñ–¥–∫—É</button>
    </div>

    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        const tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –ó–º—ñ–Ω–Ω–∞ –¥–ª—è —Ç–∏–ø—É –ø–æ—à—É–∫—É
        let currentSearchType = 'all';

        // –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –≤ localStorage
        class DocumentDatabase {
            constructor() {
                this.incomingKey = 'correspondence_incoming';
                this.outgoingKey = 'correspondence_outgoing';
                this.counterKey = 'correspondence_counters';
                this.filesKey = 'correspondence_files';
            }

            getIncoming() {
                return JSON.parse(localStorage.getItem(this.incomingKey) || '[]');
            }

            getOutgoing() {
                return JSON.parse(localStorage.getItem(this.outgoingKey) || '[]');
            }

            getCounters() {
                return JSON.parse(localStorage.getItem(this.counterKey) || '{"incoming": 0, "outgoing": 0}');
            }

            getFiles() {
                return JSON.parse(localStorage.getItem(this.filesKey) || '{}');
            }

            saveIncoming(documents) {
                localStorage.setItem(this.incomingKey, JSON.stringify(documents));
            }

            saveOutgoing(documents) {
                localStorage.setItem(this.outgoingKey, JSON.stringify(documents));
            }

            saveCounters(counters) {
                localStorage.setItem(this.counterKey, JSON.stringify(counters));
            }

            saveFiles(files) {
                localStorage.setItem(this.filesKey, JSON.stringify(files));
            }

            generateDocNumber(type) {
                const counters = this.getCounters();
                const date = new Date();
                const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                
                counters[type]++;
                this.saveCounters(counters);
                
                const prefix = type === 'incoming' ? 'IN' : 'OUT';
                const number = String(counters[type]).padStart(3, '0');
                
                return `${prefix}-${dateStr}-${number}`;
            }

            addDocument(type, data, docNumber = null) {
                const documents = type === 'incoming' ? this.getIncoming() : this.getOutgoing();
                
                const document = {
                    id: Date.now(),
                    docNumber: docNumber || this.generateDocNumber(type),
                    ...data,
                    createdAt: new Date().toISOString()
                };

                documents.push(document);
                
                if (type === 'incoming') {
                    this.saveIncoming(documents);
                } else {
                    this.saveOutgoing(documents);
                }

                return document;
            }

            saveFile(docNumber, file) {
                const files = this.getFiles();
                const reader = new FileReader();
                
                return new Promise((resolve) => {
                    reader.onload = function(e) {
                        files[docNumber] = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };
                        localStorage.setItem('correspondence_files', JSON.stringify(files));
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            }

            getFile(docNumber) {
                const files = this.getFiles();
                return files[docNumber] || null;
            }

            search(query, type = 'all') {
                let documents = [];
                
                if (type === 'all' || type === 'incoming') {
                    const incoming = this.getIncoming().map(doc => ({ ...doc, type: 'incoming' }));
                    documents = documents.concat(incoming);
                }
                
                if (type === 'all' || type === 'outgoing') {
                    const outgoing = this.getOutgoing().map(doc => ({ ...doc, type: 'outgoing' }));
                    documents = documents.concat(outgoing);
                }

                const lowerQuery = query.toLowerCase();
                return documents.filter(doc => {
                    return (
                        (doc.registrar && doc.registrar.toLowerCase().includes(lowerQuery)) ||
                        (doc.fromWhom && doc.fromWhom.toLowerCase().includes(lowerQuery)) ||
                        (doc.toWhom && doc.toWhom.toLowerCase().includes(lowerQuery)) ||
                        (doc.subject && doc.subject.toLowerCase().includes(lowerQuery)) ||
                        (doc.content && doc.content.toLowerCase().includes(lowerQuery)) ||
                        (doc.notes && doc.notes.toLowerCase().includes(lowerQuery)) ||
                        (doc.docNumber && doc.docNumber.toLowerCase().includes(lowerQuery))
                    );
                });
            }
        }

        const db = new DocumentDatabase();

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            setDefaultDates();
        });

        function updateStats() {
            const incoming = db.getIncoming();
            const outgoing = db.getOutgoing();
            
            document.getElementById('incomingCount').textContent = incoming.length;
            document.getElementById('outgoingCount').textContent = outgoing.length;
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const inDate = document.getElementById('inDate');
            const outDate = document.getElementById('outDate');
            
            if (inDate) inDate.value = today;
            if (outDate) outDate.value = today;
        }

        function showMessage(message, type = 'success') {
            const successEl = document.getElementById('successMessage');
            const errorEl = document.getElementById('errorMessage');
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            successEl.classList.remove('active');
            errorEl.classList.remove('active');
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω–µ
            if (type === 'success') {
                successEl.textContent = message;
                successEl.classList.add('active');
            } else {
                errorEl.textContent = message;
                errorEl.classList.add('active');
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                successEl.classList.remove('active');
                errorEl.classList.remove('active');
            }, 5000);
            
            // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –¥–æ –ø–æ—á–∞—Ç–∫—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideAllForms() {
            document.querySelectorAll('.form-container, .search-container, .table-container').forEach(form => {
                form.classList.remove('active');
            });
        }

        function showIncomingForm() {
            hideAllForms();
            const docNumber = db.generateDocNumber('incoming');
            document.getElementById('incomingDocNumber').textContent = `–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${docNumber}`;
            document.getElementById('incomingForm').classList.add('active');
            window.scrollTo({ top: document.getElementById('incomingForm').offsetTop - 20, behavior: 'smooth' });
        }

        function showOutgoingForm() {
            hideAllForms();
            const docNumber = db.generateDocNumber('outgoing');
            document.getElementById('outgoingDocNumber').textContent = `–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${docNumber}`;
            document.getElementById('outgoingForm').classList.add('active');
            window.scrollTo({ top: document.getElementById('outgoingForm').offsetTop - 20, behavior: 'smooth' });
        }

        function showIncomingTable() {
            hideAllForms();
            renderDocumentTable('incoming');
            document.getElementById('incomingTable').classList.add('active');
            window.scrollTo({ top: document.getElementById('incomingTable').offsetTop - 20, behavior: 'smooth' });
        }

        function showOutgoingTable() {
            hideAllForms();
            renderDocumentTable('outgoing');
            document.getElementById('outgoingTable').classList.add('active');
            window.scrollTo({ top: document.getElementById('outgoingTable').offsetTop - 20, behavior: 'smooth' });
        }

        function showSearch() {
            hideAllForms();
            document.getElementById('searchContainer').classList.add('active');
            window.scrollTo({ top: document.getElementById('searchContainer').offsetTop - 20, behavior: 'smooth' });
        }

        function showHelp() {
            hideAllForms();
            document.getElementById('helpContainer').classList.add('active');
            window.scrollTo({ top: document.getElementById('helpContainer').offsetTop - 20, behavior: 'smooth' });
        }

        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('.search-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        }

        function renderDocumentTable(type) {
            const documents = type === 'incoming' ? db.getIncoming() : db.getOutgoing();
            const containerId = type === 'incoming' ? 'incomingTableContent' : 'outgoingTableContent';
            const container = document.getElementById(containerId);
            
            if (documents.length === 0) {
                container.innerHTML = '<div class="no-files">üìã –î–æ–∫—É–º–µ–Ω—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ</div>';
                return;
            }

            const orgLabel = type === 'incoming' ? '–í—ñ–¥ –∫–æ–≥–æ' : '–ö–æ–º—É';
            const dateLabel = type === 'incoming' ? '–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è' : '–î–∞—Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏';
            
            let tableHTML = `
                <table class="document-table">
                    <thead>
                        <tr>
                            <th>–ù–æ–º–µ—Ä</th>
                            <th>–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä</th>
                            <th>${orgLabel}</th>
                            <th>–¢–µ–º–∞</th>
                            <th>–ó–º—ñ—Å—Ç</th>
                            <th>${dateLabel}</th>
                            <th>–§–∞–π–ª–∏</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            documents.forEach(doc => {
                const file = db.getFile(doc.docNumber);
                const fileCell = file ? 
                    `<button class="btn btn-small" onclick="viewFile('${doc.docNumber}')">üìé –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
                     <button class="btn btn-small" onclick="downloadFile('${doc.docNumber}')">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>` :
                    '<span class="no-files">–ù–µ–º–∞—î</span>';

                tableHTML += `
                    <tr>
                        <td><strong>${doc.docNumber}</strong></td>
                        <td>${doc.registrar || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</td>
                        <td>${doc.fromWhom || doc.toWhom || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</td>
                        <td>${doc.subject || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</td>
                        <td>${(doc.content || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ').length > 50 ? 
                            (doc.content || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ').substring(0, 50) + '...' : 
                            (doc.content || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ')}</td>
                        <td>${doc.receivedDate || doc.sentDate || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</td>
                        <td class="actions">${fileCell}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function viewFile(docNumber) {
            const file = db.getFile(docNumber);
            if (!file) {
                showMessage('‚ùå –§–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }

            // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ñ–∞–π–ª –≤ –Ω–æ–≤–æ–º—É –≤—ñ–∫–Ω—ñ
            const newWindow = window.open();
            if (file.type.includes('image')) {
                newWindow.document.write(`
                    <html>
                        <head><title>–ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–∞–π–ª—É - ${file.name}</title></head>
                        <body style="margin:0;padding:20px;text-align:center;">
                            <h3>${file.name}</h3>
                            <img src="${file.data}" style="max-width:100%;height:auto;" />
                        </body>
                    </html>
                `);
            } else {
                newWindow.location.href = file.data;
            }
        }

        function downloadFile(docNumber) {
            const file = db.getFile(docNumber);
            if (!file) {
                showMessage('‚ùå –§–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }

            const a = document.createElement('a');
            a.href = file.data;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage(`‚úÖ –§–∞–π–ª "${file.name}" –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ`);
        }

        // –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel
        function exportIncoming() {
            exportToExcel(db.getIncoming(), 'incoming', '–í—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è');
        }

        function exportOutgoing() {
            exportToExcel(db.getOutgoing(), 'outgoing', '–í–∏—Ö—ñ–¥–Ω–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü—ñ—è');
        }

        function exportToExcel(documents, type, title) {
            if (documents.length === 0) {
                showMessage('‚ùå –ù–µ–º–∞—î –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'error');
                return;
            }

            const orgLabel = type === 'incoming' ? '–í—ñ–¥ –∫–æ–≥–æ' : '–ö–æ–º—É';
            const dateLabel = type === 'incoming' ? '–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è' : '–î–∞—Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏';
            
            let csvContent = '\uFEFF'; // BOM –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            csvContent += `"–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞","–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä","${orgLabel}","–¢–µ–º–∞","–ó–º—ñ—Å—Ç","${dateLabel}","–ü—Ä–∏–º—ñ—Ç–∫–∏","–§–∞–π–ª","–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"\n`;
            
            // –î–∞–Ω—ñ
            documents.forEach(doc => {
                const file = db.getFile(doc.docNumber);
                const fileName = file ? file.name : '–ù–µ–º–∞—î';
                const fileLink = file ? `data:${file.type};base64,${file.data.split(',')[1]}` : '–ù–µ–º–∞—î';
                
                const row = [
                    doc.docNumber || '',
                    doc.registrar || '',
                    doc.fromWhom || doc.toWhom || '',
                    doc.subject || '',
                    doc.content || '',
                    doc.receivedDate || doc.sentDate || '',
                    doc.notes || '',
                    fileName,
                    fileLink
                ].map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',');
                
                csvContent += row + '\n';
            });

            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${title}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage(`‚úÖ –ï–∫—Å–ø–æ—Ä—Ç "${title}" –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!`);
        }

        // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º
        document.getElementById('incomingFormData').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const formData = new FormData(this);
                const docNumber = document.getElementById('incomingDocNumber').textContent.split(': ')[1];
                
                const data = {
                    registrar: formData.get('registrar'),
                    fromWhom: formData.get('fromWhom'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    receivedDate: formData.get('receivedDate'),
                    notes: formData.get('notes') || ''
                };

                // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É
                const file = formData.get('file');
                if (file && file.size > 0) {
                    await db.saveFile(docNumber, file);
                }

                // –ó–º–µ–Ω—à—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫, –æ—Å–∫—ñ–ª—å–∫–∏ –Ω–æ–º–µ—Ä –≤–∂–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π
                const counters = db.getCounters();
                counters.incoming--;
                db.saveCounters(counters);

                const document = db.addDocument('incoming', data, docNumber);
                
                showMessage(`‚úÖ –í—Ö—ñ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ! –ù–æ–º–µ—Ä: ${document.docNumber}`);
                
                this.reset();
                setDefaultDates();
                updateStats();
                hideAllForms();

                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'document_registered',
                        type: 'incoming',
                        docNumber: document.docNumber
                    }));
                }
            } catch (error) {
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞', 'error');
                console.error(error);
            }
        });

        document.getElementById('outgoingFormData').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const formData = new FormData(this);
                const docNumber = document.getElementById('outgoingDocNumber').textContent.split(': ')[1];
                
                const data = {
                    registrar: formData.get('registrar'),
                    toWhom: formData.get('toWhom'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    sentDate: formData.get('sentDate'),
                    notes: formData.get('notes') || ''
                };

                // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É
                const file = formData.get('file');
                if (file && file.size > 0) {
                    await db.saveFile(docNumber, file);
                }

                // –ó–º–µ–Ω—à—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫, –æ—Å–∫—ñ–ª—å–∫–∏ –Ω–æ–º–µ—Ä –≤–∂–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π
                const counters = db.getCounters();
                counters.outgoing--;
                db.saveCounters(counters);

                const document = db.addDocument('outgoing', data, docNumber);
                
                showMessage(`‚úÖ –í–∏—Ö—ñ–¥–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ! –ù–æ–º–µ—Ä: ${document.docNumber}`);
                
                this.reset();
                setDefaultDates();
                updateStats();
                hideAllForms();

                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'document_registered',
                        type: 'outgoing',
                        docNumber: document.docNumber
                    }));
                }
            } catch (error) {
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞', 'error');
                console.error(error);
            }
        });

        function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                showMessage('‚ö†Ô∏è –í–≤–µ–¥—ñ—Ç—å –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç', 'error');
                return;
            }

            try {
                const results = db.search(query, currentSearchType);
                
                const resultsContainer = document.getElementById('searchResults');
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <span style="font-size: 48px;">üîç</span>
                            <p>–ó–∞ –∑–∞–ø–∏—Ç–æ–º "${query}" –¥–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
                        </div>
                    `;
                } else {
                    const typeLabel = currentSearchType === 'incoming' ? '–≤—Ö—ñ–¥–Ω–∏—Ö' : 
                                     currentSearchType === 'outgoing' ? '–≤–∏—Ö—ñ–¥–Ω–∏—Ö' : '';
                    
                    resultsContainer.innerHTML = `
                        <h4>–ó–Ω–∞–π–¥–µ–Ω–æ ${typeLabel} –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤: ${results.length}</h4>
                        ${results.map(doc => {
                            const file = db.getFile(doc.docNumber);
                            return `
                            <div class="document-card">
                                <div class="document-header">
                                    <span class="document-number">${doc.docNumber}</span>
                                    <span class="document-type ${doc.type === 'incoming' ? 'type-incoming' : 'type-outgoing'}">
                                        ${doc.type === 'incoming' ? 'üì• –í—Ö—ñ–¥–Ω–∏–π' : 'üì§ –í–∏—Ö—ñ–¥–Ω–∏–π'}
                                    </span>
                                </div>
                                <div class="document-content">
                                    <div class="field">
                                        <span class="label">–†–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä:</span>
                                        ${doc.registrar || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}
                                    </div>
                                    <div class="field">
                                        <span class="label">${doc.type === 'incoming' ? '–í—ñ–¥:' : '–ö–æ–º—É:'}</span>
                                        ${doc.fromWhom || doc.toWhom}
                                    </div>
                                    <div class="field">
                                        <span class="label">–¢–µ–º–∞:</span>
                                        ${doc.subject}
                                    </div>
                                    <div class="field">
                                        <span class="label">–ó–º—ñ—Å—Ç:</span>
                                        ${doc.content.length > 100 ? doc.content.substring(0, 100) + '...' : doc.content}
                                    </div>
                                    <div class="field">
                                        <span class="label">–î–∞—Ç–∞:</span>
                                        ${doc.receivedDate || doc.sentDate}
                                    </div>
                                    ${file ? `
                                        <div class="field">
                                            <span class="label">üìé –§–∞–π–ª:</span>
                                            ${file.name}
                                            <br>
                                            <button class="btn btn-small" onclick="viewFile('${doc.docNumber}')">üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
                                            <button class="btn btn-small" onclick="downloadFile('${doc.docNumber}')">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                                        </div>
                                    ` : ''}
                                    ${doc.notes ? `
                                        <div class="field">
                                            <span class="label">–ü—Ä–∏–º—ñ—Ç–∫–∏:</span>
                                            ${doc.notes}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `}).join('')}
                    `;
                }
            } catch (error) {
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ—à—É–∫—É', 'error');
                console.error(error);
            }
        }

        // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—ñ–≤
        document.getElementById('inFile').addEventListener('change', function(e) {
            const label = document.querySelector('label[for="inFile"]');
            if (e.target.files.length > 0) {
                label.textContent = `üìé ${e.target.files[0].name}`;
            } else {
                label.textContent = 'üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª';
            }
        });

        document.getElementById('outFile').addEventListener('change', function(e) {
            const label = document.querySelector('label[for="outFile"]');
            if (e.target.files.length > 0) {
                label.textContent = `üìé ${e.target.files[0].name}`;
            } else {
                label.textContent = 'üìé –í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª';
            }
        });

        // –ü–æ—à—É–∫ –ø–æ Enter
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Telegram WebApp –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        if (tg) {
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä–æ–≤–æ—ó —Å—Ö–µ–º–∏
            if (tg.themeParams) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f8f9fa');
            }

            // –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
            tg.onEvent('backButtonClicked', function() {
                hideAllForms();
                tg.BackButton.hide();
            });

            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Ñ–æ—Ä–º
            const originalFunctions = {
                showIncomingForm: showIncomingForm,
                showOutgoingForm: showOutgoingForm,
                showSearch: showSearch,
                showHelp: showHelp,
                showIncomingTable: showIncomingTable,
                showOutgoingTable: showOutgoingTable
            };

            showIncomingForm = function() {
                originalFunctions.showIncomingForm();
                tg.BackButton.show();
            };

            showOutgoingForm = function() {
                originalFunctions.showOutgoingForm();
                tg.BackButton.show();
            };

            showSearch = function() {
                originalFunctions.showSearch();
                tg.BackButton.show();
            };

            showHelp = function() {
                originalFunctions.showHelp();
                tg.BackButton.show();
            };

            showIncomingTable = function() {
                originalFunctions.showIncomingTable();
                tg.BackButton.show();
            };

            showOutgoingTable = function() {
                originalFunctions.showOutgoingTable();
                tg.BackButton.show();
            };

            const originalHideAllForms = hideAllForms;
            hideAllForms = function() {
                originalHideAllForms();
                tg.BackButton.hide();
            };
        }

        // –î–µ–º–æ-–¥–∞–Ω—ñ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è (—Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö)
        /*
        function addDemoData() {
            if (db.getIncoming().length === 0 && db.getOutgoing().length === 0) {
                db.addDocument('incoming', {
                    registrar: '–Ü–≤–∞–Ω–æ–≤ –Ü.–Ü.',
                    fromWhom: '–ú—ñ–Ω—ñ—Å—Ç–µ—Ä—Å—Ç–≤–æ –æ—Å–≤—ñ—Ç–∏ —ñ –Ω–∞—É–∫–∏ –£–∫—Ä–∞—ó–Ω–∏',
                    subject: '–©–æ–¥–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∞—Ç–µ—Å—Ç–∞—Ü—ñ—ó',
                    content: '–Ü–Ω—Ñ–æ—Ä–º—É—î–º–æ –ø—Ä–æ —Ç–µ—Ä–º—ñ–Ω–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∞—Ç–µ—Å—Ç–∞—Ü—ñ—ó –ø–µ–¥–∞–≥–æ–≥—ñ—á–Ω–∏—Ö –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤',
                    receivedDate: '2024-09-01',
                    notes: '–¢–µ—Ä–º—ñ–Ω–æ–≤–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ 15.09.2024'
                });

                db.addDocument('outgoing', {
                    registrar: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ü.–ü.',
                    toWhom: '–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –æ—Å–≤—ñ—Ç–∏ —Ç–∞ –Ω–∞—É–∫–∏',
                    subject: '–ó–≤—ñ—Ç –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω—É —Ä–æ–±–æ—Ç—É',
                    content: '–ü–æ–¥–∞—î–º–æ –∑–≤—ñ—Ç –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω—É —Ä–æ–±–æ—Ç—É –∑–∞ —Å–µ—Ä–ø–µ–Ω—å 2024 —Ä–æ–∫—É',
                    sentDate: '2024-09-05',
                    notes: '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—é –ø–æ—à—Ç–æ—é'
                });

                updateStats();
            }
        }
        addDemoData();
        */
    </script>
</body>
</html>
